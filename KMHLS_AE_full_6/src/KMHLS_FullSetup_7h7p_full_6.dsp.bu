// Faust Decoder Configuration File
// Written by Ambisonic Decoder Toolbox, version 8.0
// run by henrik_frisk on  (x86_64-apple-darwin17.7.0) at 28-Oct-2019 23:20:49

//------- decoder information -------
// decoder file = ../decoders/KMHLS_FullSetup_7h7p_allrad_5200_rE_max_2_band.dsp
// description = KMHLS_FullSetup_7h7p_allrad_5200_rE_max_2_band
// speaker array name = KMHLS_FullSetup
// horizontal order   = 7
// vertical order     = 7
// coefficient order  = acn
// coefficient scale  = SN3D
// input scale        = SN3D
// mixed-order scheme = HP
// input channel order: W Y Z X V T R S U Q O M K L N P 44S 43S 42S 41S 40C 41C 42C 43C 44C 55S 54S 53S 52S 51S 50C 51C 52C 53C 54C 55C 66S 65S 64S 63S 62S 61S 60C 61C 62C 63C 64C 65C 66C 77S 76S 75S 74S 73S 72S 71S 70C 71C 72C 73C 74C 75C 76C 77C 
// output speaker order: S1 S2 S3 S4 S5 S6 S7 S8 S9 S10 S11 S12 S13 S14 S15 S16 S17 S18 S19 S20 S21 S22 S23 S24 S25 S26 S27 S28 S29 S33 S34 S35 S36 S37 S38 S39 S40 S41 S42 S43 S44 S45 S46 S47 S48 
//-------


// start decoder configuration
declare name "KMHLS_FullSetup_7h7p_full_6";

// bands
nbands = 2;

// decoder type
decoder_type = 2;

// crossover frequency in Hz
xover_freq = hslider("xover [unit:Hz]",400,200,800,20): dezipper;

// lfhf_balance
lfhf_ratio = hslider("lf/hf [unit:dB]", 0, -3, +3, 0.1): mu.db2linear : dezipper;


// decoder order
decoder_order = 7;

// ambisonic order of each input component
co = ( 0, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7);

// use full or reduced input set
input_full_set = 1;

// delay compensation
delay_comp = 1;

// level compensation
level_comp = 1;

// nfc on input or output
nfc_output = 1;
nfc_input  = 0;

// enable output gain and muting controls
output_gain_muting = 1;

// number of speakers
ns = 45;

// radius for each speaker in meters
rs = (          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,         4.882,         4.882,         4.882,         4.882,         4.882,         4.882,         4.882,         4.882,         5.317,         5.317,         5.317,         5.317,         5.576,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61,          4.61);

// per order gains, 0 for LF, 1 for HF.
//  Used to implement shelf filters, or to modify velocity matrix
//  for max_rE decoding, and so forth.  See Appendix A of BLaH6.
gamma(0) = (             1,             1,             1,             1,             1,             1,             1,             1);
gamma(1) = (             1,  0.9602898565,  0.8832349127,  0.7734093083,  0.6372937645,  0.4828486811,  0.3189921291,  0.1550188129);

// gain matrix
s(00,0) = (  0.0173517055,  0.0296654548,  0.0146881238,  0.0385625593,  0.0617547406,  0.0242265677, -0.0304204424,  0.0301655273,   0.016700725,  0.0673834744,  0.0523507333, -0.0211637868, -0.0395116522,  -0.029526496,  0.0118537247, -0.0270355077,  0.0394563788,   0.057950522, -0.0250783768, -0.0402620459,  0.0115401831, -0.0515151876, -0.0104138279, -0.0275033416, -0.0644419073,  -0.006187204,  0.0313150793, -0.0181004758, -0.0657052268, -0.0027149637,  0.0465529212,  0.0007134705, -0.0174955157,  0.0002569195, -0.0619175302, -0.0735481112, -0.0445603152, -0.0126936269, -0.0124374012, -0.0607790894, -0.0154141167,  0.0348941231,  0.0144612206,   0.047595756,  0.0015761389,  0.0233798153,  0.0018232664, -0.0682517712, -0.0518599868, -0.0585430824, -0.0477434108, -0.0121441721, -0.0330698056, -0.0182362895,   0.045591458,  0.0210614765, -0.0313442831,  0.0235241848,  0.0166791036,  0.0159514018,  0.0484105274,  0.0026486737, -0.0439044347, -0.0145601399);
s(01,0) = (  0.0121423434,   0.008166631,  0.0080504287,   0.033948018,  0.0215195561,  0.0053739679, -0.0246715269,  0.0212768029,  0.0422492512,  0.0362625092,   0.015085925,  -0.007798497, -0.0239365806, -0.0338370016,  0.0280507115,  0.0425728351,  0.0491248237,  0.0270991579, -0.0137353747, -0.0102913309,  0.0187239267, -0.0416733095, -0.0291500954,  0.0297486419,  0.0358915684,  0.0576307317,  0.0387466064, -0.0165299553, -0.0225658232,  0.0033982126,  0.0347398171,  0.0175661293, -0.0434337481, -0.0224321276,  0.0257461164,  0.0241171955,  0.0604021012,  0.0474522738, -0.0160236645,  -0.033805599,  0.0024977609,  0.0118211568, -0.0039784561,  0.0499075592,  0.0090645322, -0.0392432617, -0.0156457441,  0.0167889216,  0.0097937683,   0.057270897,  0.0513461094, -0.0130231612, -0.0415962715,   -0.00155835,  0.0219497709,  0.0020590636, -0.0348599619,   0.004307264,  0.0449124034,  0.0029003616,  -0.030541514, -0.0103794205,  0.0047209765,  -0.004392054);
s(02,0) = (  0.0174661019,  -0.006535444,   0.014732654,  0.0485469447, -0.0173188131, -0.0043816192, -0.0307154107,   0.038575807,  0.0620233563, -0.0295073609, -0.0123431639,  0.0061069487, -0.0397144989, -0.0362964768,  0.0524349656,  0.0668049169, -0.0406568725, -0.0223544971,  0.0106972762,  0.0082661784,  0.0118913806, -0.0652940073, -0.0254706906,  0.0603492762,  0.0640957824, -0.0488409668, -0.0323905096,  0.0128587745,  0.0181103429, -0.0024478363,  0.0470192994, -0.0009890062, -0.0660837471, -0.0132535135,  0.0615546273,  0.0555714309, -0.0528412686, -0.0404307838,  0.0125269537,  0.0272452797, -0.0014916642, -0.0092613971,  0.0142653668,  0.0590997831,  -0.015104731, -0.0597282038, -0.0019687197,  0.0565128333,  0.0433148618, -0.0522419886, -0.0448901228,  0.0103457443,  0.0338604433,  0.0018613232, -0.0171044199, -0.0018550186, -0.0320250429,  0.0314594021,  0.0463047584, -0.0239624885, -0.0483715649,  0.0066662692,  0.0466726647,  0.0295501761);
s(03,0) = (  0.0121692494, -0.0184110658,     0.0080647,  0.0297580194, -0.0425395078, -0.0113458644, -0.0247318656,  0.0188293614,  0.0211584261, -0.0557727435, -0.0282275621,  0.0186099617, -0.0239814551, -0.0294251209,  0.0148658184, -0.0052783762, -0.0484765565, -0.0402277511,  0.0293770128,  0.0223984042,  0.0187892484, -0.0367160072, -0.0134639448, -0.0024083395, -0.0368961539, -0.0222653383, -0.0383231488,   0.027560335,   0.043724373, -0.0101590944,   0.034817924,  0.0148356065, -0.0222097747,  0.0046515375, -0.0264657988, -0.0584185271,  0.0116327369, -0.0206551753,  0.0156948082,  0.0516915986,  -0.009187164,  -0.027207986, -0.0040345816,  0.0436315224,   0.002384387,   0.004583044,  0.0160888903, -0.0459382659, -0.0600658931,  0.0389094217,  0.0061540902,  0.0013168311,  0.0410661698, -0.0009537813, -0.0452558963, -0.0015465804, -0.0349738931,  0.0044589225,  0.0215688817, -0.0032822977,  0.0313982731,  0.0166923115, -0.0511929192, -0.0421510267);
s(04,0) = (  0.0177769474, -0.0399229285,   0.015043623,  0.0297978742, -0.0625922985, -0.0312496123, -0.0311855749,  0.0243329644, -0.0188865548, -0.0245526329, -0.0531047042,  0.0305635897, -0.0404913973, -0.0212846224, -0.0137054213, -0.0697592768,  0.0436552929, -0.0253554141,  0.0253995111,  0.0533820008,  0.0118821999, -0.0404762581,  0.0113062785, -0.0602009632, -0.0629265404,  0.0742961913,  0.0353568374, -0.0003472488,  0.0666766767, -0.0007254943,  0.0477848632, -0.0026775192,  0.0198211966,  0.0184387621, -0.0607619725,  -0.000970008,  0.0399356837,  0.0694004682, -0.0125293885,  0.0212139721,  0.0156620859, -0.0493739799,  0.0147595758,  0.0351774946, -0.0010456547,  0.0629267174,   0.001324086, -0.0077544902,   0.055300034, -0.0199150921,  0.0436207009, -0.0018737044,   -0.03617073,  0.0152220806, -0.0463520666, -0.0244016808, -0.0323310456,  0.0211505515, -0.0183041055,  0.0192334606,  0.0472018198, -0.0120883883,  0.0476470706,   0.056036274);
s(05,0) = (  0.0122919182, -0.0345108213,   0.008136989,  0.0076172284, -0.0201381578, -0.0216047173, -0.0249998318,   0.005027099, -0.0435210991,  0.0450030794, -0.0141670747,   0.034448976, -0.0242176159, -0.0072634917, -0.0288920315, -0.0341287478,  0.0466255329,    0.03151628,  0.0128109685,  0.0423666924,  0.0190303709,  -0.009629649,  0.0300514613, -0.0256163378,  0.0398196948,  -0.029635049,  0.0369810368, -0.0236211504,  0.0211893062, -0.0179631426,  0.0352113964,   0.003134226,  0.0447698527,  0.0154408882,  0.0288018332,  0.0553438461, -0.0589398484, -0.0212924333, -0.0149570637, -0.0415109536, -0.0022266728, -0.0508370121, -0.0041222216,  0.0110607458, -0.0093649148,  0.0319218552, -0.0169806311,  0.0459005793, -0.0166860096,  0.0033767501, -0.0505874031,  0.0116470711, -0.0395809308,  0.0029188317, -0.0205898323, -0.0042928784, -0.0354296548,  0.0019902697,  -0.046341117,  0.0017019274, -0.0338402428, -0.0120454425, -0.0105348341, -0.0571210184);
s(06,0) = (  0.0179759708, -0.0496797462,  0.0152102627, -0.0082717252,  0.0216787129, -0.0396130745, -0.0315349869, -0.0057907998, -0.0623923045,  0.0651763201,  0.0161097188,  0.0369253572, -0.0409364886,  0.0073694848, -0.0530006792,  0.0363413541, -0.0489922538,  0.0593248734, -0.0123857741,  0.0668677088,  0.0120221507,  0.0106335012,  0.0251970474,  0.0286671599,  0.0595849128, -0.0479382934,  -0.040584202, -0.0121388075, -0.0228035904,  0.0014151623,  0.0483075061, -0.0023358551,  0.0664347722,   -0.01402425,    0.05796622, -0.0572229601,  0.0597542554, -0.0499270297,  0.0124947644, -0.0580249857,  0.0002645032,  -0.060204109,  0.0149024243, -0.0113756619,  0.0157702004,  -0.033380041,  -0.000456506, -0.0491770243, -0.0330680808,  0.0178441693,  0.0525920135, -0.0079785452,  0.0400960936, -0.0241930578,  0.0203264776, -0.0324520558,  -0.032694956, -0.0030662656, -0.0460210697, -0.0045450949, -0.0443441372,  0.0089488481, -0.0374274707,  0.0565109821);
s(07,0) = (  0.0124723197, -0.0297759182,  0.0082610322, -0.0199645747,  0.0449877426, -0.0188399483, -0.0253550017, -0.0123225125, -0.0184054127, -0.0116003212,  0.0299154498,  0.0294495407, -0.0245731414,  0.0201492983, -0.0130363411,  0.0559884411, -0.0432788284, -0.0069781105, -0.0309712861,  0.0367505316,  0.0192760441,  0.0243021465,   0.011587758,   0.040540928, -0.0443387175,  0.0622617764, -0.0346117404,  0.0077157511, -0.0462668063, -0.0148455471,   0.035693074, -0.0109410863,  0.0194169858, -0.0274416225, -0.0323795514, -0.0113202961, -0.0247320474,  0.0496110826,  0.0134453318,   0.010365761,  0.0095285165,  -0.043687384, -0.0041504781, -0.0294641115, -0.0018082731, -0.0519395783,  0.0183923612, -0.0120089367,  0.0563598163, -0.0306229837, -0.0174535754, -0.0167039499,  0.0367207741, -0.0033464048,  0.0477489047,  -0.004490997, -0.0358652812, -0.0017647177, -0.0187297023,  0.0005855315,  0.0375937308,  -0.001652678,  0.0489478624, -0.0483710755);
s(08,0) = (  0.0168837615,  -0.027112731,  0.0141814517, -0.0388887965,  0.0585170324, -0.0220701686, -0.0298001046, -0.0302280145,  0.0218887162, -0.0690746581,  0.0495350401,  0.0195070731,  -0.038324688,  0.0301244596,  0.0161223445,  0.0169625881,  0.0499464777, -0.0596447377, -0.0240017144,  0.0368576107,  0.0118083966,  0.0519347904, -0.0127271378,  0.0187913896, -0.0550275061, -0.0109362105,  0.0412796454,  0.0182984558, -0.0624923802,  0.0022093131,  0.0456258038,  -0.001379146,   -0.02300194,  0.0022493434, -0.0540889063,  0.0721133175, -0.0282507815, -0.0030952288, -0.0129732426,  0.0625149758, -0.0143993075, -0.0322863958,  0.0134572634, -0.0485900102,  0.0006070107, -0.0145425393, -0.0002928005,  0.0685127499, -0.0618066481,  0.0507828865, -0.0339930808,    0.01280363, -0.0410849154,  0.0191981861,  0.0438273343, -0.0191931401, -0.0314574863, -0.0233064265,   0.020750693, -0.0131493344,  0.0411874809,  -3.12685e-05, -0.0550198652,  0.0326474325);
s(09,0) = (  0.0166288795, -0.0065763686,  0.0139324784, -0.0462513406,  0.0174644977, -0.0043610464, -0.0294219552,  -0.036541627,  0.0590953917, -0.0298409646,  0.0123275796,  0.0062190835, -0.0377300667,  0.0349887358,  0.0497830501, -0.0635890604,  0.0412662267, -0.0224331648, -0.0109826885,  0.0082876245,  0.0118156072,  0.0622587262,  -0.024689827, -0.0574520164,  0.0608389517, -0.0497972528,  0.0327089115,  0.0133172361, -0.0182559086, -0.0026237346,  0.0451118843,  0.0002356081,  -0.063240646,  0.0128097195,  0.0587727826,  -0.052425355,  0.0541791809, -0.0411598584, -0.0130684812,  0.0276365664,  0.0018209097, -0.0094054342,  0.0131285031, -0.0571017938, -0.0139767061,   0.057294956, -0.0015511481, -0.0541200656,  0.0403465237, -0.0539473955,  0.0461826873,  0.0107947805, -0.0345812003,  0.0015051155,  0.0175081965,  -0.001711796, -0.0313663357, -0.0296962775,  0.0450049532,  0.0229524766,  -0.046344745,  -0.007383845,  0.0448142466, -0.0267629989);
s(10,0) = (  0.0122519133,  0.0077890747,  0.0080658692, -0.0343690767, -0.0205832842,  0.0051041465, -0.0249576325, -0.0213943254,  0.0432005364,  0.0348462835, -0.0143775897, -0.0074658054,  -0.024013405,  0.0344122679,  0.0285112084, -0.0443761831, -0.0475221827,  0.0259709283,   0.013207497, -0.0097923941,  0.0191207083,  0.0419745333, -0.0299807145, -0.0308817529,  0.0387811127,  0.0562614082, -0.0374317659, -0.0159802691,  0.0215511775,  0.0033077485,  0.0349402356, -0.0181908686, -0.0442121424,  0.0234773343,  0.0278374705,  -0.028143733, -0.0596971636,  0.0463480534,  0.0155667012, -0.0324595021,  -0.002520789,  0.0112842904,  -0.004414866, -0.0504213592,  0.0096531111,  0.0407235019, -0.0167576904, -0.0199613679,  0.0147881122,  0.0575606073, -0.0509051124, -0.0126561902,  0.0402202391, -0.0013469698, -0.0210362963,  0.0018803834, -0.0352165223,   -0.00376019,  0.0458361718, -0.0032543204,  -0.032788705,   0.011372537,  0.0088631288,  -0.001205303);
s(11,0) = (   0.016899001,  0.0280836693,  0.0142656394, -0.0382314023, -0.0595927691,  0.0228417573,  -0.029716101, -0.0299108348,  0.0189450389,   0.067686701, -0.0504664467, -0.0202180887, -0.0384768202,  0.0293273849,   0.014017185,  0.0222228183, -0.0441023557,  0.0585901387,  0.0243782584, -0.0381432687,  0.0114670459,  0.0511972721, -0.0109541929,  0.0228566349, -0.0600764948,  0.0013209424, -0.0364368803, -0.0176827392,  0.0635981814, -0.0022586491,  0.0455885511, -0.0007265438, -0.0199901813,  0.0001792233, -0.0579660453,  0.0732620466,  0.0381606732, -0.0048814498,  0.0115455537, -0.0612184225,  0.0147567957,  0.0333981494,  0.0139434598, -0.0474896875,    0.00038207, -0.0192118893,  0.0013690377,  0.0689006407, -0.0567963229, -0.0567032606,  0.0418155992, -0.0109649477,  0.0364277272, -0.0191264753,  -0.044474396,  0.0198328484, -0.0310454823, -0.0235465831,  0.0180148104, -0.0136594015,  0.0451940142, -0.0011367948, -0.0500452938,  0.0223743154);
s(12,0) = (  0.0115571903,  0.0278907766,  0.0076511251, -0.0181327538, -0.0414236368,  0.0176248494, -0.0234996259, -0.0111909168, -0.0183374942,  0.0086368018,  -0.027518741, -0.0276104972, -0.0227601348,  0.0183102897, -0.0128853253,  0.0529826969,  0.0434018175,  0.0050040035,  0.0285721086,  -0.034388746,  0.0178838747,   0.022082653,  0.0116624026,  0.0382460397, -0.0396602525, -0.0589950071,   0.034381001, -0.0060765629,  0.0426089824,  0.0139821576,  0.0330690189, -0.0099588112,  0.0192406337, -0.0261498555, -0.0288647503, -0.0151574302,  0.0193947513, -0.0467537083, -0.0139506356, -0.0077663233, -0.0088762253,   0.040912038,  -0.003893695, -0.0268032579, -0.0020601055, -0.0491295752,  0.0166976282, -0.0146896892,  0.0571403857,  0.0354761986,  0.0131765581,  0.0163435377, -0.0367649454,   0.002956789, -0.0440717621,  0.0040803923, -0.0332590484,  -0.001587343, -0.0186678212,  0.0008539455,  0.0337979541, -0.0001340975,  0.0490389684,  -0.045194867);
s(13,0) = (  0.0171159819,  0.0472527396,  0.0146665511, -0.0080785879, -0.0212455383,  0.0381809964, -0.0297676772, -0.0056105808, -0.0592715296, -0.0617749902,  -0.015679665, -0.0344306597, -0.0393248387,  0.0072763469, -0.0511149104,  0.0357998102,  0.0486010472, -0.0572822135,  0.0123438124,  -0.064059343,  0.0106044642,  0.0103805129,  0.0228530221,  0.0280893384,  0.0561792335,  0.0446238497,  0.0401295377,  0.0099555321,  0.0224122836, -0.0029121846,     0.0459672, -0.0024256028,  0.0634532866, -0.0141447463,  0.0560229448, -0.0572789644, -0.0604910403,  0.0481937359, -0.0127776777,  0.0551390788, -0.0005129106,  0.0567973432,  0.0153991961, -0.0112396435,  0.0168894746, -0.0330992117,  0.0016662592, -0.0492101694,  -0.029763111, -0.0143441779, -0.0534519308,  0.0101694192, -0.0402006051,  0.0251515044, -0.0202621837,  0.0325842293,  -0.030306671, -0.0029162225, -0.0427833077, -0.0042349965, -0.0416542246,  0.0092568287, -0.0358227717,  0.0580158208);
s(14,0) = (  0.0121517424,  0.0343086964,  0.0080115141,  0.0066573067,  0.0176824781,   0.021377224, -0.0247367827,    0.00447685, -0.0440350552, -0.0470733133,  0.0126653066, -0.0343220192, -0.0238393379, -0.0062313292, -0.0290537462, -0.0302382983, -0.0418831299,  -0.032700925, -0.0109191208,  -0.041919301,  0.0189071227, -0.0084942106,  0.0305698116, -0.0230855638,  0.0441108523,  0.0364074992,  -0.033751573,  0.0249920197, -0.0187072369,  0.0180867774,  0.0346515232,  0.0024603913,  0.0450612126,   0.013086811,  0.0316138454,  0.0506744322,  0.0553542652,  0.0260742176,  0.0125940794,  0.0431948044,   0.001337742,  0.0503078321,  -0.004289355,  0.0095784483, -0.0098556764,  0.0283310186, -0.0191506992,   0.042650327, -0.0256860866, -0.0138665485,  0.0481596665, -0.0143461656,  0.0354934176, -0.0035790931,  0.0177528655,  0.0038428988, -0.0348638402,  0.0020710923, -0.0467271735,  0.0024237247, -0.0373265895, -0.0100209365, -0.0172035848, -0.0554474015);
s(15,0) = (  0.0120597401,  0.0295908519,  0.0080539394,  0.0180607804,  0.0418831286,  0.0188768286,  -0.024445595,  0.0111949218, -0.0214613175,  0.0042459413,  0.0279642858, -0.0291018254, -0.0239206737, -0.0182013398, -0.0152251735, -0.0553320382, -0.0488788758,  0.0015782288, -0.0287671542, -0.0367355313,  0.0183921513, -0.0220866219,  0.0134847381, -0.0401810636, -0.0354222905, -0.0572537378, -0.0389373211,  -0.004294118, -0.0432690888,  0.0143474592,  0.0346494863,  0.0098158009,  0.0226537418,  0.0270656365, -0.0253574202,  0.0237485798, -0.0094794142, -0.0451119892,  0.0154760455, -0.0036555077,  0.0086995392,  0.0435039569, -0.0035983235,  0.0268014745, -0.0020794956,  0.0515239449,   0.015637538,  0.0221392553,  0.0599735287,  0.0434008959, -0.0040829713,  0.0163941922,  0.0415507129,  0.0034744727,  0.0447063816,  0.0050112574,  -0.034672275,  0.0017607825, -0.0218416112, -0.0004447185,  0.0303316752, -0.0012607244,  0.0512877787,  0.0369702675);
s(16,0) = (  0.0389359004,  0.0258369542,  0.0730907593,  0.0790967813,  0.0480246049,  0.0438587823,  0.0247242058,  0.1356615161,    0.06470592,   0.052728592,  0.0847168637,  0.0305806987, -0.0553800916,  0.1007985804,  0.1137285452,  0.0372378095,   0.042564238,  0.0960019872,  0.0758395981, -0.0059110683, -0.0871467143,  0.0005619734,  0.1038907615,  0.0659738016,  0.0138388486,  0.0266659557,  0.0781226153,  0.0958848772,  0.0226578448, -0.0335280914, -0.0485554277, -0.0726242349,  0.0414140226,  0.0645423567,   0.023019951,  0.0011971447,  0.0126980795,  0.0476340489,  0.0805434045,  0.0474263203, -0.0310125018, -0.0309047284,  0.0098382557, -0.0650944856, -0.0158168185,  0.0352361402,  0.0204603954,  0.0001516868, -0.0021111381,  0.0037706115,  0.0208144055,  0.0465321181,  0.0447483943, -0.0095811351, -0.0450104841, -0.0073278609,  0.0303463208, -0.0117868219,  -0.024361017,  0.0086396824,  0.0098681472, -0.0031801373, -0.0041940988, -0.0005870021);
s(17,0) = (   0.032144031, -0.0324570478,    0.05629634,  0.0654787095, -0.0597469082, -0.0522084646,  0.0068646756,   0.106752281,  0.0449066054, -0.0618418835,  -0.100558322, -0.0306441549, -0.0645447536,   0.064936305,  0.0777263902,  0.0104764496, -0.0428467481,  -0.109361915, -0.0810074494,   0.015789418, -0.0819956817, -0.0307057563,  0.0660255655,  0.0212420659, -0.0144473742, -0.0185183781, -0.0791920423, -0.1032633504, -0.0114329486,  0.0428125629, -0.0303458322, -0.0916897678,  0.0127511158,  0.0244899888, -0.0235490306, -0.0207890769, -0.0022685259, -0.0357917163, -0.0827951808, -0.0428987461,  0.0464418965,  0.0292949941,  0.0339685845, -0.0692990896, -0.0381695901,  0.0147762702, -0.0193180235, -0.0365231681, -0.0135593523,  0.0021174614, -0.0051556522, -0.0405996394, -0.0477873166,   0.020048982,  0.0480974037, -0.0024028396,  0.0514368949, -0.0013000793, -0.0478501073, -0.0031324936, -0.0053211186, -0.0351904815, -0.0237383482, -0.0034493821);
s(18,0) = (  0.0395166583, -0.0808136808,   0.074133704,  0.0243202724, -0.0453998507, -0.1385429382,   0.024915885,  0.0412290404, -0.0675695113,  0.0408923765, -0.0799873327, -0.1027107279, -0.0565076882,   0.028616354, -0.1187872858, -0.0501467267,  0.0407282142,  0.0727228878, -0.0713750652,   5.40006e-05, -0.0887177056, -0.0058092885, -0.1083702305, -0.0912010455,  0.0173942952, -0.0038786782,  0.0746725006,  0.0713708175, -0.0208872135,  0.0751074501, -0.0493060866, -0.0317366448, -0.0425273905,  -0.090838211,  0.0297286289,  0.0255413758, -0.0118732782,  -0.005154209,  0.0767597356,  0.0385150082,  0.0298599145,  0.0673096288,  0.0102925752, -0.0290742605,  0.0181998421, -0.0444289887,  0.0276337967,  0.0454992024,  0.0005593707,   2.88395e-05, -0.0191150214, -0.0020618588,  0.0421520587,  0.0073815909,  0.0428410479,  0.0122657395,   0.031306727,  -0.006713113,  0.0277438457,  0.0099793397,  0.0139925393,  0.0441193598,   0.001479628, -0.0028994643);
s(19,0) = (  0.0317779492, -0.0641313184,  0.0554719974, -0.0336948328,  0.0615871892, -0.1043094927,  0.0062667457, -0.0539374139, -0.0417371408,  0.0057115325,  0.1033305972, -0.0629192676,  -0.064254195, -0.0310701998, -0.0724368768,  0.0625145192, -0.0413558233,   0.013146887,  0.0825278143,  0.0308654028, -0.0807548764,  0.0173005525, -0.0618733722,  0.1105747111, -0.0191247431,  0.0236313098, -0.0769633972,   0.017543044,  0.0103375189,  0.0900164032, -0.0289100171,  0.0447794421, -0.0123781624,  0.1043614503, -0.0319487154, -0.0155733275, -0.0004210592,  0.0421434384, -0.0814056022,  0.0130388526, -0.0490397483,  0.0672100845,  0.0345696515,  0.0297736924,  0.0355047786,  0.0430609024, -0.0275370761, -0.0309046275,  0.0141600156, -0.0028861232,  0.0004018791,  0.0417300332, -0.0481479766, -0.0001926128, -0.0497601108,  0.0002648813,  0.0508331461, -0.0036268271,  0.0452803328, -0.0210748996, -0.0090558534, -0.0365614289,  0.0254589089, -0.0033240106);
s(20,0) = (  0.0341328459, -0.0233769556,  0.0661523781, -0.0679899269,  0.0443138782, -0.0398394551,  0.0276602482, -0.1211456865,  0.0540602426, -0.0504647112,  0.0785611273, -0.0280880536, -0.0430821714,  -0.099162839,  0.1002470553, -0.0283471511,  0.0431538483, -0.0925937743,  0.0710032699,  0.0048909403, -0.0789524102, -0.0149702233,  0.1015201096, -0.0552134354,  0.0055458327, -0.0295269064,  0.0803333741, -0.0936604736,   0.022067186,  0.0302478094, -0.0537319834,  0.0585762655,  0.0539669023, -0.0637325387,  0.0123988413,  0.0079689754,   0.016260198, -0.0542952125,  0.0847643478, -0.0476341116,  -0.028284365,  0.0283380749, -0.0017042562,  0.0677541346, -0.0021039495, -0.0481332685,  0.0182811114,  0.0135226961, -0.0125642221, -0.0067215047,  0.0285258957,   -0.05598411,   0.049382412,  0.0083822157, -0.0423439778,  0.0070733942,  0.0268081619,  0.0269482348, -0.0256492346, -0.0235267621,   0.021148038,  0.0109987395, -0.0217012019,  0.0116887381);
s(21,0) = (   0.030686754,  0.0244521496,  0.0535257039, -0.0656843844, -0.0462794247,  0.0414300622,  0.0059497676, -0.1056797826,   0.055674328,   0.052324425, -0.0816331087,  0.0286972616, -0.0620787771, -0.0613967273,  0.0915842353, -0.0328271898, -0.0440604306,  0.0956288604, -0.0730319643, -0.0059923405, -0.0777831412,  0.0346757879,  0.0688878649, -0.0532662783,  0.0120505132,  0.0292749671, -0.0818458287,   0.096179947,  -0.021595634, -0.0321908591, -0.0275724602,  0.0918601163,  0.0002205725,  -0.040390552,  0.0163532834, -0.0001376329, -0.0152181087,  0.0538627582, -0.0863226786,  0.0483726086,  0.0305814219, -0.0297266563,  0.0335233611,  0.0642380654, -0.0528571173,  -0.000595364,  0.0051090617,  0.0043710238, -0.0032141807,  0.0054833766, -0.0267815762,  0.0560054403, -0.0507698999, -0.0091690855,   0.044797437, -0.0074450256,   0.048765029, -0.0048871733, -0.0481812532,  0.0303728642, -0.0157388455,  0.0143711057, -0.0082917308,  0.0016126282);
s(22,0) = (  0.0315846399,  0.0639034872,  0.0554443176, -0.0327476721, -0.0600769105,  0.1044964968,  0.0070786338, -0.0527373106,   -0.04253874, -0.0075418295, -0.1012831045,   0.064181008, -0.0632335591, -0.0310452771, -0.0740576406,  0.0617000074,  0.0419299437, -0.0163425667, -0.0818499918, -0.0292068235, -0.0809952621,   0.015903693, -0.0637075567,  0.1093853518, -0.0174119935,  -0.023230637,  0.0778481119, -0.0204805862, -0.0117935921, -0.0897040917, -0.0307131142,  0.0434445577, -0.0134573261,  0.1037341853,  -0.028781882, -0.0169295497, -0.0003909044, -0.0409962958,  0.0820052638, -0.0141308246,   0.046978767, -0.0690051472,  0.0328623208,  0.0299703578,  0.0357432636,  0.0435722682, -0.0242369981, -0.0331582396,  0.0151932668,  0.0043273016, -0.0019291707, -0.0397380561,   0.048073855,  0.0009575671,  0.0492347036,  -0.002686247,  0.0510638721, -0.0022440007,  0.0465044275, -0.0199179197, -0.0072046444, -0.0384055795,  0.0268004737, -0.0038883552);
s(23,0) = (   0.042479525,   0.086306478,  0.0777221091,  0.0305791533,  0.0565207609,  0.1447242077,  0.0212296047,   0.049048283, -0.0669515903, -0.0318921803,  0.0947564582,   0.100904202, -0.0653947564,   0.028565992, -0.1173150315,   -0.05881435, -0.0407784697, -0.0595153381,  0.0756927956,  -0.009775432, -0.0919276269,  -0.014959924, -0.1064412524, -0.1034647339,  0.0047585449, -0.0047548949, -0.0747531275, -0.0641439825,  0.0099442949, -0.0817012274, -0.0414987731, -0.0396499922, -0.0413171899, -0.0967076164,  0.0106395068,  0.0169663684,  0.0003721555, -0.0082344717, -0.0769902995, -0.0432505366,  -0.043478053,  -0.062020836,  0.0206966511, -0.0261497786,  0.0176508997, -0.0389273366,  0.0158193924,  0.0321487704,  0.0005513851, -0.0074424761,  0.0006817472, -0.0069789015, -0.0428629299, -0.0179969962, -0.0430994545, -0.0004184661,    0.03185487,  0.0036185691,  0.0257425491,  0.0196994575,   0.018747609,  0.0352288301,  0.0010603196,  0.0047059953);
s(24,0) = (  0.0254848385,  0.0220263973,  0.0669407106,  0.0219154887,  0.0188895248,  0.0532528341,  0.0843550147,  0.0529947699, -0.0001143287,  0.0074215374,  0.0473105299,  0.0802267994,  0.0742492643,  0.0798672787, -0.0002846297, -0.0075645291,  -6.83278e-05,  0.0194436361,  0.0775273042,  0.0911705677,  0.0448441938,  0.0908243938, -0.0004590781, -0.0198233442, -0.0055343296, -0.0018226468, -0.0001922234,  0.0338803845,  0.0970212747,  0.0828670773,  0.0108062189,  0.0826617551, -0.0005533202, -0.0345510793, -0.0151802614, -0.0017719496, -0.0008758206, -0.0052185131, -0.0003634153,  0.0452545958,  0.0975673777,  0.0612338482, -0.0146085142,  0.0612468017, -0.0005095594, -0.0461598383, -0.0279242884, -0.0050672702,   1.10941e-05,  -2.94885e-05,  -0.002598647, -0.0100626245, -0.0005285364,  0.0484313065,  0.0797547696,  0.0370197293, -0.0255275082,  0.0372426858, -0.0003313707, -0.0494010364, -0.0395133267, -0.0097580107,   3.60357e-05,   2.32569e-05);
s(25,0) = (  0.0342672386, -0.0221166977,  0.0882500942,   0.036347146, -0.0188521144, -0.0533630464,  0.1059216186,  0.0859909754,  0.0110994197, -0.0072807379, -0.0470621702, -0.0801182577,  0.0834174503,  0.1245961587,  0.0269801361,  0.0001976359,  0.0001095549, -0.0189388041, -0.0767226094,  -0.090556429,  0.0354121333,   0.132225081,   0.042095312,  0.0003366362, -0.0005022314,   0.001689487,  0.0003943265, -0.0326343391, -0.0952398373,  -0.081620654, -0.0140094637,  0.1057515086,  0.0485056251,  0.0001322562, -0.0013064535,    0.00120803,  0.0006710446,  0.0048826579,  0.0009882834, -0.0428146362, -0.0945348864, -0.0595417749, -0.0445057959,  0.0591076255,  0.0419030702, -0.0007047144, -0.0021902911,  0.0036029609,  0.0015209375, -0.0001184947,  0.0020033243,  0.0095518174,  0.0019881279, -0.0444289328, -0.0755789927, -0.0353687039, -0.0490151497,  0.0141196407,   0.024339521,  -0.002180448, -0.0025871423,  0.0073654382,  0.0046630341,    0.00060702);
s(26,0) = (  0.0340686883, -0.0360210073,  0.0877469248, -0.0223415236,  0.0192173694, -0.0852277699,  0.1053520488, -0.0538309155, -0.0107599187,  -0.000135485,  0.0478923619, -0.1235207157,  0.0830633053, -0.0806420311, -0.0261788064,  0.0075846199,  -3.87946e-05, -0.0004750324,  0.0778864717, -0.1311634807,  0.0354754776, -0.0908540074, -0.0409009969,  0.0196926114,  -0.000748532, -0.0011009454,  -1.62738e-05, -0.0011407392,  0.0963615693, -0.1050707507, -0.0134977841, -0.0815165633, -0.0472265532,  0.0338503402, -0.0019315949,  0.0016694532, -0.0007031092, -0.0033206177,  0.0002224569, -0.0021590565,  0.0952100341, -0.0590342487, -0.0437028413,  -0.059098053, -0.0409361909,  0.0442698875, -0.0032231794,  0.0047963976, -0.0015409844,  0.0006939383,  -0.002068545, -0.0068776836,  0.0008808643, -0.0033925877,  0.0756294634, -0.0146321522,  -0.048196677, -0.0348497427, -0.0239533527,  0.0457503884, -0.0038418433,  0.0093138253, -0.0047241395,   9.27715e-05);
s(27,0) = (  0.0424027981,  0.0360226875,  0.1079464385, -0.0360071718, -0.0188934804,  0.0851469788,  0.1257305059, -0.0850421345,  0.0001325816,    4.6512e-06, -0.0469808387,  0.1231784569,  0.0915987015, -0.1228703683,  0.0002487492, -0.0003324332, -0.0001617369,    8.2827e-06,  -0.076127181,  0.1303688167,  0.0263377365, -0.1298028248,  0.0002164754, -0.0007911693,  0.0043209737,  0.0012526867, -0.0004357506,   -7.2931e-06, -0.0936259037,  0.1037612626, -0.0371455603, -0.1030427476,  -4.72804e-05,  -0.001202162,  0.0119838293, -0.0012754428,  0.0005682752,  0.0036984153, -0.0007815068,  -8.49496e-05, -0.0915756179,  0.0573878834, -0.0719789867, -0.0567845898, -0.0004594561, -0.0013246812,  0.0224367977, -0.0037257916,  0.0001358243, -0.0004979356,  0.0017081735,  0.0074419114, -0.0010664432, -0.0002882939, -0.0714170333,  0.0130691499, -0.0701682861, -0.0128812919, -0.0007912984, -0.0010930651,   0.032689232, -0.0074049237,  0.0003718894, -0.0006870326);
s(28,0) = (  0.0102900397,    1.9657e-06,  0.0304481074,   -8.5177e-06,    1.1512e-06,    5.6355e-06,  0.0493629167,  -2.33718e-05,   -1.7518e-06,      6.31e-07,    3.4689e-06,   1.10318e-05,  0.0662800898,  -4.28226e-05,     -5.29e-06,    1.0543e-06,     3.364e-07,    2.0761e-06,    7.3387e-06,   1.80029e-05,  0.0805519338,  -6.39242e-05,  -1.12209e-05,    3.3269e-06,  -2.78667e-05,      2.57e-08,    1.1881e-06,    4.8663e-06,   1.28405e-05,   2.63071e-05,  0.0916704765,  -8.33967e-05,   -1.9692e-05,    7.3863e-06,  -9.83703e-05,       4.2e-09,        -4e-09,     1.019e-07,    3.0007e-06,    9.4678e-06,   1.98308e-05,   3.55893e-05,  0.0992917068,  -9.80781e-05,   -3.0507e-05,   1.34191e-05, -0.0002483242,       2.6e-09,     -1.25e-08,        -8e-10,     -1.51e-08,     2.904e-07,    6.2857e-06,   1.62694e-05,   2.79496e-05,   4.53624e-05,  0.1032496351, -0.0001053596,  -4.31219e-05,   2.11744e-05, -0.0005199756,     -3.44e-08,     -4.89e-08,     -2.13e-08);
s(29,0) = (  0.0339854821,   0.035999882, -0.0359963588,  0.0802532514,  0.0824521556, -0.0316373921, -0.0314096407, -0.0705286381,  0.0734153269,  0.1163306727,  -0.069419295, -0.0087417167,  0.0429094085, -0.0194796025, -0.0618114147,  0.0367406175,  0.1243276865, -0.0953899844, -0.0040866358,  0.0173993375,  0.0098920379,  0.0387861092, -0.0036228926, -0.0301249763, -0.0144284503,  0.1043784417, -0.0993009117,  0.0051383479,  0.0194348019,  0.0077311252, -0.0208497842,  0.0172014783,  0.0172924743,  0.0016463813,  0.0115334032, -0.0621134743,  0.0645977361, -0.0807956933,   0.012059638,  0.0113960112,  0.0194147081,  -0.010799613, -0.0152405943, -0.0240364513,  0.0172509568,  0.0035712999, -0.0013704416,  0.0481063058, -0.0918305585,  0.0189370555, -0.0480353385,  0.0132745196,  0.0005724279,  0.0308148175, -0.0195911594, -0.0080436224,  0.0159788443,    -0.0179135, -0.0173907233,  0.0097006762, -0.0001133044,  -0.007867926,  0.0683566717, -0.0971544092);
s(30,0) = (  0.0341288712,  0.0021928951, -0.0357965145,  0.0883968747,  0.0055052596, -0.0019055225, -0.0319326832, -0.0768105289,   0.110944865,  0.0091264992, -0.0045699534, -0.0005419473,  0.0425243424,  -0.022290322, -0.0922545824,   0.122487431,  0.0124847616, -0.0073632158, -0.0003096186,   0.001014283,  0.0106104272,  0.0418939317, -0.0064985249, -0.0991315745,  0.1254462725,  0.0151415515, -0.0097965814,  0.0003310616,  0.0012093478,  0.0005084659, -0.0203283447,  0.0198525447,  0.0253248503,  0.0043465337, -0.0988818257,  0.1214073622,   0.016787485, -0.0115064005,  0.0011044183,  0.0007698476,   0.001366815, -0.0006280201, -0.0159344957, -0.0254546743,  0.0268816481,  0.0112198064,  0.0111550806, -0.0928191255,  0.1117978962,  0.0172514497, -0.0122621875,  0.0017959796,  -8.79192e-05,  0.0025122277, -0.0012435262, -0.0005086457,  0.0152307689, -0.0205991216, -0.0251894741,  0.0330614196, -0.0001062949,  0.0145904594, -0.0823005396,  0.0980540657);
s(31,0) = (  0.0339966103, -0.0318913358, -0.0359743824,  0.0819987258, -0.0746196891,  0.0279819077, -0.0314135265, -0.0719548619,  0.0814200151, -0.1094785314,  0.0627030405,  0.0077611802,  0.0427538122, -0.0199568613, -0.0684331357,  0.0539708241, -0.1247754448,  0.0895847134,  0.0037614395,    -0.0153161,  0.0100336568,  0.0394109129, -0.0040979499, -0.0441886707,  0.0108904168, -0.1167011601,  0.0994621698, -0.0047302192, -0.0174152781,  -0.006923099, -0.0207547221,  0.0177711214,  0.0190326826,  0.0023477252,  -0.008717775, -0.0340549727, -0.0891353633,    0.09020427, -0.0119842974,  -0.010520877, -0.0176984739,  0.0094996847, -0.0153163114, -0.0244291487,  0.0192763725,  0.0052135712,  0.0010722092,  0.0262697273, -0.0684618576, -0.0513522672,  0.0662838304, -0.0147517134, -0.0004008193, -0.0291496542,  0.0175980588,  0.0071566273,  0.0157857882,  -0.018386613, -0.0191957288,  0.0143370098,    5.9188e-05, -0.0042659422,  0.0508294591, -0.0847565057);
s(32,0) = (   0.034376846, -0.0619228317, -0.0360982774,  0.0639806634, -0.1117141593,  0.0539008696, -0.0321240694, -0.0556522259,  0.0036687244, -0.0915021501,  0.0930354105,   0.015513203,  0.0429151797, -0.0160977621,  -0.002993529, -0.0828758926, -0.0083638168,  0.0741010252,  0.0064228195, -0.0294120236,  0.0105930119,  0.0304159862,  -0.000307593,  0.0672443965, -0.1262355269,  0.0791540667,  0.0064789288, -0.0032392032, -0.0256005903, -0.0138141603, -0.0205349703,  0.0142857448,  0.0008752504, -0.0031234211,  0.0996469896, -0.0935288047,  0.1123494917, -0.0606826463, -0.0005798353, -0.0084821858, -0.0269734579,  0.0179036203, -0.0159937647, -0.0184746581,  0.0008953789, -0.0076185244, -0.0113323075,  0.0714881142, -0.0112909783,  0.0778107633, -0.0827480057,  0.0096907734,  -4.58998e-05, -0.0246470531,  0.0254737504,  0.0143825403,  0.0154318296, -0.0149041162, -0.0007941389, -0.0223238403,   2.55998e-05, -0.0111670226,  0.0081758067,   0.061369877);
s(33,0) = (  0.0344169534, -0.0819450327, -0.0363389296,   0.034927997, -0.0806058354,  0.0717464676, -0.0319378065, -0.0305874358, -0.0773844901,  0.0436926876,  0.0675905582,   0.020160876,  0.0432680588, -0.0085816519,  0.0648753606,  -0.115314396,  0.1261530074, -0.0356487661,   0.004239085, -0.0393684409,   0.010253254,  0.0167664555,  0.0040842187,  0.0941307668, -0.0051209491,  0.0523912095, -0.1002626039,  0.0017809975,  -0.018795755, -0.0178441123,  -0.020924656,  0.0076276114, -0.0180591984, -0.0047252757,  0.0040958035,  0.1103619894, -0.0745938184, -0.0403830267,   0.011813919,  0.0041922537, -0.0191873018,    0.02422274, -0.0156464103, -0.0103487077, -0.0183797611, -0.0110514645, -0.0004875484, -0.0849753913,  0.0841816409, -0.0935288675,  0.0551603091,  0.0064922581,  0.0003578006,  0.0116203414,  0.0188709565,  0.0185948083,  0.0158997767, -0.0079119213,   0.018075039, -0.0307752146,  -1.87298e-05,  0.0136526286, -0.0623345816, -0.0312892305);
s(34,0) = (  0.0347152705, -0.0898382403, -0.0365762853,   1.68337e-05,  -5.12437e-05,  0.0784304454, -0.0322479783,   1.09431e-05, -0.1126450264,  0.1242159033,  -2.72128e-05,  0.0222397576,  0.0433858857,  -2.64533e-05,  0.0941157954, -0.0001025116,  0.0001702578, -0.1009950171,   5.66281e-05, -0.0427662312,  0.0105596445,  -1.86345e-05,  0.0061573344,  -4.46669e-05,  0.1270213357, -0.1226840517,   5.70764e-05,  0.0048199089,   5.00913e-05, -0.0199169825,  -0.020893629,   2.46889e-05, -0.0259109278,   8.80368e-05, -0.1005346163,  0.0002527901, -0.0003464706,  0.0940806808,  -0.000115885,  0.0115751536,  -5.83298e-05,  0.0262777994,  -0.015962729,   3.96573e-05, -0.0270894522,    8.9008e-05,  0.0116244435,   5.83282e-05, -0.1126677689,  0.0984479251,  -4.38809e-05, -0.0149443026, -0.0001300744,  0.0333759163,  -8.01272e-05,  0.0205953277,  0.0157491066,  -4.28982e-05,  0.0260185502,  -9.82966e-05,   7.38736e-05,  -0.000134472,  0.0830309709, -0.0004455683);
s(35,0) = (  0.0349377949, -0.0831632836, -0.0367748085, -0.0355247348,  0.0818910455,  0.0725768797, -0.0325624004,  0.0309980838, -0.0783597284,  0.0439411936, -0.0684008896,   0.020674531,  0.0437990941,  0.0088331616,  0.0654694828,  0.1168829682, -0.1273872062, -0.0357462571, -0.0045201535, -0.0397359326,  0.0105385363, -0.0169633292,  0.0043141551,  -0.095013438, -0.0056393744,  0.0532643039,  0.1008031798,  0.0017107581,  0.0189044714, -0.0182934383, -0.0210000202, -0.0078237726, -0.0181128795,  0.0045042392,  0.0044246688, -0.1107816527,  0.0741228639,  -0.040780133, -0.0116404955,  0.0041386122,  0.0196058158,  0.0242579998, -0.0160871451,    0.01035765, -0.0187427302,  0.0109399847, -0.0004901996,  0.0849299227,  0.0847589572, -0.0932530307, -0.0546080624,  0.0064454901,  -8.33694e-05,  0.0117582295,  -0.018850244,  0.0190860892,  0.0159349454,  0.0081521238,  0.0180608335,  0.0313220601,   2.65285e-05, -0.0134821288, -0.0623583403,  0.0303135515);
s(36,0) = (  0.0341170799, -0.0613021601, -0.0359172178, -0.0636048666,  0.1108558581,  0.0535121021, -0.0317292645,  0.0554308921,  0.0041147918, -0.0914314748, -0.0925518664,   0.015193917,  0.0425977844,  0.0158667863, -0.0032696554,  0.0817185159,   0.009469013,  0.0741061926, -0.0061432557, -0.0292092571,  0.0104579676, -0.0302537749, -0.0003923579, -0.0666246656, -0.1254790697,   0.077757611, -0.0070719532, -0.0033282521,  0.0255069392, -0.0135734747, -0.0205557256, -0.0141547382,  0.0008671916,   0.003330231,   0.099343018,   0.094150912, -0.1120769625, -0.0600950861,  0.0005088154, -0.0084384655,  0.0266588666,  0.0179396107, -0.0156602249,  0.0185043866,  0.0010749356,  0.0077141005, -0.0115023372, -0.0719112453, -0.0130005134,  0.0791993722,  0.0828474603,  0.0098391067, -0.0001738448, -0.0246358641, -0.0255364421,  0.0140369949,  0.0153638478,  0.0146607274, -0.0007660339,  0.0218716222, -0.0001003224,  0.0112376104,  0.0089732852, -0.0600288624);
s(37,0) = (  0.0325375103, -0.0312354526, -0.0343445682, -0.0783443833,  0.0730925302,  0.0273709521,  -0.030214339,   0.068587093,  0.0771083149, -0.1071969799, -0.0613573967,  0.0076670577,  0.0409235749,  0.0192668228, -0.0646272331, -0.0495528946,  0.1219952016,  0.0876571597, -0.0037940165, -0.0150329517,  0.0096611224, -0.0376029455, -0.0040568501,  0.0403727834,  0.0066097552, -0.1136297274, -0.0972208426, -0.0045151211,  0.0171127996, -0.0067874574, -0.0197157483, -0.0170748364,   0.017925386, -0.0020096923, -0.0050553603,  0.0382086152,  0.0858070966,  0.0878491289,  0.0116372159, -0.0103770625,  0.0173473066,   0.009275963,   -0.01486661,  0.0231185218,  0.0183591978,   -0.00463697,  0.0005178695,  -0.029850301, -0.0726195448,  -0.047615886, -0.0638263389, -0.0143403856,  0.0004813512, -0.0285385192, -0.0172019366,  0.0070789924,  0.0150776661,  0.0178285665, -0.0179713857, -0.0132673953,  -0.000172058,  0.0049909044,  0.0545023551,  0.0890012621);
s(38,0) = (  0.0339145867,  0.0011029234, -0.0356718423, -0.0878395366, -0.0027476353, -0.0009809587, -0.0316089789,  0.0765607695,   0.110333793,  0.0044979874,  0.0023437961, -0.0002562781,  0.0423775155,  0.0219239638, -0.0920524384, -0.1220087285, -0.0060428517, -0.0037369907,  0.0001079839,  0.0005457507,  0.0104017754, -0.0418308305, -0.0062018825,  0.0990926527,  0.1252646228,  0.0071471966,  0.0048849361,  0.0002383744, -0.0006722409,    0.00022133, -0.0203956143, -0.0195323242,  0.0254021265, -0.0046014904, -0.0990964072, -0.1216488535,  -0.007653511, -0.0055834313, -0.0006255536,  0.0004833243, -0.0006239543, -0.0003454738, -0.0156464849,  0.0256079759,  0.0265549269, -0.0113972137,  0.0113957981,  0.0933374372,  0.1125354337,  0.0074881624,  0.0057080659,  0.0009308739,   -9.5044e-05,  0.0011595073,  0.0007010016, -0.0002381072,  0.0153168045,  0.0202231399, -0.0253825421, -0.0327788628,   0.000113221,  -0.014838681, -0.0831233166, -0.0992992737);
s(39,0) = (  0.0342118234,  0.0345684767, -0.0361376166, -0.0815256939, -0.0798911279,  -0.030240654, -0.0317157599,  0.0714279527,  0.0772341322,  0.1145522271,  0.0669324505, -0.0085181397,  0.0430093474,  0.0199841155, -0.0648697994, -0.0440146149, -0.1256996892,  -0.093474679,  0.0042355329,  0.0165625086,  0.0101555443, -0.0391794684, -0.0039392641,   0.036137453, -0.0044471914,  0.1103593916,  0.0999695906,  0.0046983359, -0.0185797135,  0.0075650916, -0.0208114779, -0.0176760844,  0.0180717088,  -0.002005944,  0.0032433422,  0.0517340685, -0.0748413196, -0.0852004307,  -0.011861602,  0.0109360826, -0.0190199529, -0.0101999173, -0.0154718324,  0.0241239428,  0.0182405278, -0.0043203336, -0.0001687506, -0.0395430479, -0.0839149188,  0.0313326178,  0.0557248908,  0.0138470158, -0.0003652869,  0.0305507106,  0.0186253039, -0.0078317714,  0.0157626138,   0.018387353, -0.0181213466,  -0.011595838,  0.0001288194,  0.0061744905,   0.061898373,  0.0937636043);
s(40,0) = (  0.0326253698,  0.0602403856, -0.0343579115, -0.0593765981, -0.1065459281, -0.0526132231, -0.0303788546,  0.0518323726,  -0.001534299,  0.0819197645,  0.0890904297, -0.0149274902,   0.040893681,  0.0147467681,  0.0013331096,  0.0855287384,  0.0035142791, -0.0666586929,  0.0058101763,  0.0287838564,   0.009843415, -0.0283595434,   2.33468e-05, -0.0697218395, -0.1224423573, -0.0879460304, -0.0029183333,  0.0031690544, -0.0246534004,  0.0132616224,  -0.019614824, -0.0131024368, -0.0003627306,  0.0034500829,  0.0972257527,  0.0818565717,  0.1124849424,  0.0679476237,  0.0004615546,  0.0077569576,  -0.025523628, -0.0176226198,  -0.015068307,  0.0173578359, -0.0003388994,  0.0081165471, -0.0113937811, -0.0630143896,  0.0048423791, -0.0677435466, -0.0837122149, -0.0110696149,   2.78643e-05,  0.0219554118,  0.0246940952, -0.0138411869,  0.0149504737,  0.0136671104,  0.0003957777,  0.0228649484, -0.0003384012,  0.0100756629, -0.0038063744, -0.0749165821);
s(41,0) = (  0.0318444848,  0.0759127503, -0.0335862291, -0.0325001495, -0.0753958231,  -0.066366706, -0.0295739688,  0.0284112945,  -0.071918979, -0.0406321011,  0.0631385874, -0.0187831307,  0.0399058755,  0.0080503083,  0.0602276448,  0.1087938522,  0.1204740253,  0.0331591314,  0.0040761707,  0.0363760313,  0.0096749307,  -0.015591934,  0.0038757999, -0.0887868528, -0.0056351897, -0.0518061694, -0.0959176338, -0.0016470249, -0.0176065555,  0.0167143403, -0.0194061105, -0.0071344001, -0.0167557374,  0.0043939134,  0.0044831803, -0.1070702034, -0.0737403659,  0.0400808511,  0.0113689336, -0.0038978534, -0.0179462856, -0.0224634821,  -0.014466945,  0.0096044923, -0.0171781527,  0.0105148066, -0.0005261825,  0.0828774892,  0.0846508414,  0.0966914382,  0.0551716335,  -0.006530875,  0.0005223694, -0.0108758822,  0.0175760307, -0.0172297098,  0.0145335732,  0.0073778368,  0.0168206384,  0.0289726728,  -4.31137e-05, -0.0135340809,  -0.063265335,  0.0313604591);
s(42,0) = (  0.0333273946,  0.0863605191, -0.0350535168, -0.0016977392, -0.0042952473, -0.0753044949, -0.0310931068,  0.0014508849, -0.1085804882, -0.1202623352,    0.00350463, -0.0215366704,  0.0417315803,  0.0004438941,   0.090649314,  0.0072027954,  0.0100128567,  0.0977667243,   0.000289765,  0.0411850254,  0.0101201165, -0.0007658477,  0.0060592987,  -0.005708246,  0.1237535315,  0.1205410942, -0.0077209805, -0.0045927843, -0.0008850803,  0.0191138632, -0.0199558415, -0.0004075218, -0.0250377419,  0.0001872029, -0.0980408432, -0.0124068553, -0.0141459467, -0.0926927025,  0.0007965643, -0.0112898815, -0.0011148717,  -0.025080271, -0.0154672647,  0.0004318399, -0.0260850041,  0.0005135415,  0.0113292563,  0.0092846531, -0.1119284641, -0.0992154008,  0.0102234906,   0.014793967, -0.0001940224, -0.0322780057,   0.000884152, -0.0200080313,  0.0151177919,  0.0004499026,  0.0249294484,   0.002057537,  0.0002073993, -0.0013906923,  0.0829628479,  0.0150757807);
s(43,0) = (  0.0338216882,  0.0818483764,  -0.035705976,   0.031132243,  0.0731207214, -0.0716553948, -0.0313636231, -0.0272042524, -0.0821732263, -0.0561402904, -0.0611936565, -0.0201107959,  0.0424463983, -0.0077010724,  0.0689594017, -0.1079479191, -0.1241702984,  0.0460212555, -0.0039344007,  0.0392517061,  0.0101298305,  0.0148876864,  0.0042512862,  0.0880052704,  0.0143446081, -0.0300900769,  0.0987018132, -0.0024804944,  0.0169521886,  0.0178793876, -0.0205588409,   0.006847687, -0.0191887221, -0.0043632296, -0.0117284768,  0.1177098412,  0.0918026041,  0.0228120937, -0.0116894876, -0.0054948599,  0.0174749233, -0.0242440995, -0.0153657849, -0.0091481524, -0.0194953203, -0.0102559404,  0.0016080177,  -0.090882116,  0.0650672776,  0.0828234833, -0.0683966581, -0.0034719669, -0.0003244862, -0.0148440529, -0.0170088407, -0.0184961829,  0.0155963539, -0.0071139752,  0.0193206392, -0.0288410166,  0.0002278075,  0.0148048709, -0.0479217874, -0.0550202143);
s(44,0) = (  0.0334724443,  0.0628859015, -0.0351643161,  0.0597497376,  0.1089713154, -0.0547483804, -0.0312497489, -0.0519943656, -0.0055815854,  0.0786904399,   -0.09078485, -0.0157603712,  0.0417637141, -0.0150048179,  0.0046966084,  -0.091834242, -0.0127990935, -0.0637614327, -0.0062580953,  0.0298862658,  0.0103512174,  0.0283877259,   0.000263661,  0.0745423196, -0.1239022935, -0.0962538447,  0.0102465894,  0.0028077201,  0.0250025786,  0.0140541097, -0.0200433532,  0.0133822104, -0.0012832571, -0.0034272063,  0.0979046136, -0.0740967826, -0.1115819327,   0.073936911, -0.0012949808,  0.0073087985,  0.0263402918, -0.0182190211, -0.0155552919, -0.0173111116, -0.0013191589, -0.0085243711, -0.0111466981,  0.0566785415,   0.017587681, -0.0567439104,  0.0824335085, -0.0118034648,    1.5552e-06,  0.0212279058, -0.0249055688, -0.0146102253,  0.0150045257, -0.0138965371,  0.0012840225,  -0.024726095,  -7.58442e-05, -0.0088477241, -0.0132532966,  0.0827283428);


// ----- do not change anything below here ----

// mask for full ambisonic set to channels in use
input_mask(0) = bus(nc);
input_mask(1) = (_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_);


// Start of decoder implementation.  No user serviceable parts below here!
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------

//declare name		"Fill in name in configuration section below";
declare version 	"1.2";
declare author 		"AmbisonicDecoderToolkit";
declare license 	"BSD 3-Clause License";
declare copyright	"(c) Aaron J. Heller 2013";

/*
Copyright (c) 2013, Aaron J. Heller
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

1. Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.

3. Neither the name of the copyright holder nor the names of its
contributors may be used to endorse or promote products derived from
this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/

/*
  Author: Aaron J. Heller <heller@ai.sri.com>
  $Id: 21810b615fa65b96af41a7c8783d7435b41084b8 $
*/

// v 1.2, 28-Oct-2017 ajh
//  . add 6th-order NFC filters
//  . fixed error in speaker_chain and speaker_chain2, where speaker 
//    distance was being indexed by order, not speaker number

// v 1.1 remove dependancies on Faust Libraries, 23-Nov-2016 ajh
//   m = library("math.lib");
//   mu = library("music.lib");

m = environment {
  // from the old math.lib
  take (1, (xs, xxs)) = xs;
  take (1, xs) = xs;
  take (nn, (xs, xxs)) = take (nn-1, xxs);

  bus(2) = _,_; // avoids a lot of "bus(1)" labels in block diagrams
  bus(n) = par(i, n, _);

  SR = min(192000, max(1, fconstant(int fSamplingFreq, <math.h>)));
  //PI = 3.1415926535897932385;
  // quad precision value
  PI = 3.14159265358979323846264338327950288;
};

mu = environment {
   // from the old music.lib
   db2linear(x)	= pow(10, x/20.0);
};



// m.SR from math.lib is an integer, we need a float
SR = float(m.SR);

// descriptive statistics
total(c) = c:>_;

average(c) = total(c)/count(c);

count(c) = R(c) :>_ with {
 R((c,cl)) = R(c),(R(cl));
 R(c)      = 1;
};

rms(c) = R(c) :> /(count(c)) : sqrt with {
 R((c,cl)) = R(c),R(cl);
 R(c)      = (c*c);
};

sup(c) = R(c) with {
 R((c,cl)) = max(R(c),R(cl));
 R(c)      = c;
};

inf(c) = R(c) with {
 R((c,cl)) = min(R(c),R(cl));
 R(c)      = c;
};

// bus
bus(n)   = par(i,n,_);

// bus with gains
gain(c) = R(c) with {
  R((c,cl)) = R(c),R(cl);
  R(1)      = _;
  R(0)      = !:0;  // need to preserve number of outputs, faust will optimize away
  R(float(0)) = R(0);
  R(float(1)) = R(1);
  R(c)      = *(c);
};

// fir filter  (new improved, better behaved)
fir(c) = R(c) :>_ with {
  R((c,lc)) = _<: R(c), (mem:R(lc));
  R(c)      = gain(c);
};

// --- phase-matched bandsplitter from BLaH3
xover(freq,n) = par(i,n,xover1) with {

	sub(x,y) = y-x;

	k = tan(m.PI*float(freq)/m.SR);
	k2 = k^2;
	d =  (k2 + 2*k + 1);
	//d = (k2,2*k,1):>_;
	// hf numerator
	b_hf = (1/d,-2/d,1/d);
	// lf numerator
	b_lf = (k2/d, 2*k2/d, k2/d);
	// denominator
	a = (2 * (k2-1) / d, (k2 - 2*k + 1) / d);
	// 
	xover1 = _:sub ~ fir(a) <: fir(b_lf),fir(b_hf):_,*(-1);
};

shelf(freq,g_lf,g_hf) = xover(freq,1) : gain(g_lf),gain(g_hf):>_;

// from http://old.nabble.com/Re%3A--Faudiostream-devel---ANN--Faust-0.9.24-p28597267.html
//   (not used currently, do we need to worry about denormals?)
anti_denormal = pow(10,-20);
anti_denormal_ac = 1 - 1' : *(anti_denormal) : + ~ *(-1); 

// UI "dezipper"
smooth(c) = *(1-c) : +~*(c);
dezipper = smooth(0.999);

// physical constants     

temp_celcius = 20;                        
c = 331.3 * sqrt(1.0 + (temp_celcius/273.15)); // speed of sound m/s


// ---- NFC filters ----
//  see BesselPoly.m for coefficient calculations
//
// [1] J. Daniel, “Spatial Sound Encoding Including Near Field Effect:
//     Introducing Distance Coding Filters and a Viable, New Ambisonic 
//     Format ,” Preprints 23rd AES International Conference, Copenhagen,
//     2003.
// [2] Weisstein, Eric W. "Bessel Polynomial." From MathWorld--A Wolfram 
//     Web Resource. http://mathworld.wolfram.com/BesselPolynomial.html
// [3] F. Adriaensen, “Near Field filters for Higher Order
//     Ambisonics,” Jul. 2006.
// [4] J. O. Smith, “Digital State-Variable Filters,” CCRMA, May 2013.
//
// [5] "A Filter Primer", https://www.maximintegrated.com/en/app-notes/index.mvp/id/733

// first and second order state variable filters see [4]
//   FIXME FIXME this code needs to be refactored, so that the roots are 
//               passed in rather then hardwired in the code, or another 
//               API layer, or ...
svf1(g,d1)    = _ : *(g) :       (+      <: +~_, _ ) ~ *(d1)                   : !,_ ;
svf2(g,d1,d2) = _ : *(g) : (((_,_,_):> _ <: +~_, _ ) ~ *(d1) : +~_, _) ~ *(d2) : !,_ ;

//  these are Bessel filters, see [1,2]
nfc1(r,gain) = svf1(g,d1)  // r in meters
 with {
   omega = c/(float(r)*SR);
   //  1  1
   b1 = omega/2.0;
   g1 = 1.0 + b1;
   d1 = 0.0 - (2.0 * b1) / g1;
   g = gain/g1;
};

nfc2(r,gain) = svf2(g,d1,d2)
 with {
   omega = c/(float(r)*SR);
   r1 = omega/2.0;
   r2 = r1 * r1;

   // 1.000000000000000   3.00000000000000   3.00000000000000
   b1 = 3.0 * r1;
   b2 = 3.0 * r2;
   g2 = 1.0 + b1 + b2;

   d1 = 0.0 - (2.0 * b1 + 4.0 * b2) / g2;  // fixed
   d2 = 0.0 - (4.0 * b2) / g2;
   g = gain/g2;
};

nfc3(r,gain) = svf2(g,d1,d2):svf1(1.0,d3)
 with {
   omega = c/(float(r)*SR);

   r1 = omega/2.0;
   r2 = r1 * r1;

   // 1.000000000000000   3.677814645373914   6.459432693483369
   b1 = 3.677814645373914 * r1;
   b2 = 6.459432693483369 * r2;         
   g2 = 1.0 + b1 + b2;
   d1 = 0.0 - (2.0 * b1 + 4.0 * b2) / g2;  // fixed
   d2 = 0.0 - (4.0 * b2) / g2;

   // 1.000000000000000   2.322185354626086
   b3 = 2.322185354626086 * r1;
   g3 = 1.0 + b3;
   d3 = 0.0 - (2.0 * b3) / g3;

   g = gain/(g3*g2);
};

nfc4(r,gain) = svf2(g,d1,d2):svf2(1.0,d3,d4)
 with {
   omega = c/(float(r)*SR);

   r1 = omega/2.0;
   r2 = r1 * r1;
   
   // 1.000000000000000   4.207578794359250  11.487800476871168
   b1 =  4.207578794359250 * r1;
   b2 = 11.487800476871168 * r2;         
   g2 = 1.0 + b1 + b2;
   d1 = 0.0 - (2.0 * b1 + 4.0 * b2) / g2;  // fixed
   d2 = 0.0 - (4.0 * b2) / g2;

   // 1.000000000000000   5.792421205640748   9.140130890277934
   b3 = 5.792421205640748 * r1;
   b4 = 9.140130890277934 * r2;         
   g3 = 1.0 + b3 + b4;
   d3 = 0.0 - (2.0 * b3 + 4.0 * b4) / g3;  // fixed
   d4 = 0.0 - (4.0 * b4) / g3;
   
   g = gain/(g3*g2);
};

nfc5(r,gain) = svf2(g,d1,d2):svf2(1.0,d3,d4):svf1(1.0,d5)
 with {
   omega = c/(float(r)*SR);

   r1 = omega/2.0;
   r2 = r1 * r1;
   
   // 1.000000000000000   4.649348606363304  18.156315313452325
   b1 =  4.649348606363304 * r1;
   b2 = 18.156315313452325 * r2;         
   g2 = 1.0 + b1 + b2;
   d1 = 0.0 - (2.0 * b1 + 4.0 * b2) / g2;  // fixed
   d2 = 0.0 - (4.0 * b2) / g2;

   // 1.000000000000000   6.703912798306966  14.272480513279568
   b3 =  6.703912798306966 * r1;
   b4 = 14.272480513279568 * r2;         
   g3 = 1.0 + b3 + b4;
   d3 = 0.0 - (2.0 * b3 + 4 * b4) / g3;  // fixed
   d4 = 0.0 - (4.0 * b4) / g3;

   // 1.000000000000000   3.646738595329718
   b5 = 3.646738595329718 * r1;
   g4 = 1.0 + b5;
   d5 = 0.0 - (2.0 * b5) / g4;

   g = gain/(g4*g3*g2);
 };

nfc6(r,gain) = svf2(g,d11,d12):svf2(1.0,d21,d22):svf2(1.0,d31,d32)
with {
   omega = c/(float(r)*SR);

   r1 = omega/2.0;
   r2 = r1 * r1;

   // reverse Bessel Poly 6:
   //   1          21         210        1260        4725       10395       10395
   // factors:
   //   1.000000000000000   5.031864495621642  26.514025344067996
   //   1.000000000000000   7.471416712651683  20.852823177396761
   //   1.000000000000000   8.496718791726696  18.801130589570320


   // 1.000000000000000   5.031864495621642  26.514025344067996
   b11 =  5.031864495621642 * r1;
   b12 = 26.514025344067996 * r2;         
   g1 = 1.0 + b11 + b12;
   d11 = 0.0 - (2.0 * b11 + 4.0 * b12) / g1;
   d12 = 0.0 - (4.0 * b12) / g1;

   // 1.000000000000000   7.471416712651683  20.852823177396761
   b21 =  7.471416712651683 * r1;
   b22 = 20.852823177396761 * r2;         
   g2 = 1.0 + b21 + b22;
   d21 = 0.0 - (2.0 * b21 + 4.0 * b22) / g2;
   d22 = 0.0 - (4.0 * b22) / g2;

   // 1.000000000000000   8.496718791726696  18.801130589570320
   b31 =  8.496718791726696 * r1;
   b32 = 18.801130589570320 * r2;         
   g3 = 1.0 + b31 + b32;
   d31 = 0.0 - (2.0 * b31 + 4.0 * b32) / g3;
   d32 = 0.0 - (4.0 * b32) / g3;

   g = gain/(g3*g2*g1);
};


// ---- End NFC filters ----

nfc(0,r,g) = gain(g);
nfc(1,r,g) = nfc1(r,g);
nfc(2,r,g) = nfc2(r,g);
nfc(3,r,g) = nfc3(r,g);
nfc(4,r,g) = nfc4(r,g);
nfc(5,r,g) = nfc5(r,g);
nfc(6,r,g) = nfc6(r,g);

// null NFC filters to allow very high order decoders. FIXME!
nfc(o,r,g) = gain(g);

//declare name "nfctest";
//process = bus(6):(nfc(0,2,1),nfc(1,2,1),nfc(2,2,1),nfc(3,2,1),nfc(4,2,1),nfc(5,2,1)):bus(6);


// top level api to NFC filters
nfc_out(1,order,r,g) = nfc(order,r,g);
nfc_out(0,order,r,g) = _;

nfc_inp(1,order,r,g) = nfc(order,r,g);
nfc_inp(0,order,r,g) = _;



// ---- delay and level
delay(dc,r)  = R(dc,r) with {
 R(0,r) = _;  // delay_comp off
 R(1,0) = _;  // delay_comp on, but no delay
 R(1,float(0)) = R(1,0);
 R(1,r) = @(meters2samples(r));
 meters2samples(r) = int(m.SR * (float(r)/float(c)) + 0.5);
};

level(lc,r,rmax) = R(lc,r,rmax) with{
 R(0,r,rmax) = _;  // level_comp off
 R(1,r,rmax) = gain(float(r)/float(rmax));
};


delay_level(r) = R(r) with {  // delay_comp and level_comp are free variables (fix?)
 R((r,rl)) =   R(r), R(rl);
 R(r)      =   delay(delay_comp,(r_max-r)) : level(level_comp,r,r_max);
};

// ---- gates
gate(0) = !;
gate(1) = _;
dirac(i,j) = i==j;
gate_bus(order,(o,oss)) = (gate(order==o),gate_bus(order,oss));
gate_bus(order,o)       =  gate(order==o);


// route (not used)
//route(n_inputs,n_outputs,outs) = m.bus(n_inputs)
//                               <: par(i,n_outputs,(0,gate_bus(i,outs)):>_


//process = route(4,4,(3,1,1,2)); // test


// deinterleave 
deinterleave(n,span) = par(i,n,_) <: par(i,span, par(j,n,gate(%(j,span)==i)));


// 1 band speaker chain
speaker_chain(ispkr) = gain(s(ispkr,0))  // decoder matrix gains
		     // iterate over orders, select each order from matrix
		     <: par(jord,no,gate_bus(jord,co)
		            // sum and apply NFC filter for that order
			    // at the speaker distance
		            :> nfc_out(nfc_output,jord,m.take(ispkr+1,rs),1.0))
		     // sum the orders
	             :>_;

// 1 band speaker chain -- bad definition
// speaker_chain(i) = gain(s(i,0)) <: par(i,no,gate_bus(i,co):>nfc_out(nfc_output,i,m.take(i+1,rs),1.0)):>_;

// near field correction at input, nfc_input = 1
nfc_input_bus(nc) = par(i,nc, nfc_inp(nfc_input, m.take(i+1,co), r_bar, 1.0));

// per order gains
gamma_bus(n) = par(i,nc, gain( m.take(m.take(i+1,co)+1, gamma(n))));

// output gain and muting
output_gain = hslider("gain [unit:dB]", -10, -30, +10, 1): mu.db2linear :*(checkbox("mute")<0.5): dezipper;

gain_muting_bus(0,n) = bus(n);
gain_muting_bus(1,n) = par(i,n,*(output_gain));


// one band decoder
decoder(1,nc,ns) = nfc_input_bus(nc) 
                :  gamma_bus(0) 
                <: par(is,ns, speaker_chain(is)) 
                : delay_level(rs); 


// two band decoder
//   there are two variants of the two-band decoder
//     1. classic, with shelf-filters and one matrix
//     2. vienna,  bandsplitting filters and separate LF and HF matricies.

// classic shelf filter decoder
decoder(2,nc,ns) = nfc_input_bus(nc) 
                :  par(i,nc, shelf(xover_freq,m.take(m.take(i+1,co)+1, gamma(0))/lfhf_ratio,
                                              m.take(m.take(i+1,co)+1, gamma(1))*lfhf_ratio))
                <: par(is,ns, speaker_chain(is)) 
                :  delay_level(rs);

// vienna decoder
//   FIXME FIXME  need to incorporate lfhf_ratio
decoder(3,nc,ns) = bus(nc)
                   : nfc_input_bus(nc) 
                   : xover(xover_freq,nc) : deinterleave(2*nc,2) 
                   : (gamma_bus(0),gamma_bus(1)) : bus(2*nc)
                   <: par(j, ns, speaker_chain2(j,nc))
                   : delay_level(rs)
; 
// 2 band speaker chain for vienna decoder
// i is speaker, j is order
speaker_chain2(i,nc) = gain(s(i,0)), gain(s(i,1))
                       :> bus(nc)
                       <: par(j,no,gate_bus(j,co):>nfc_out(nfc_output,j,m.take(i+1,rs),1.0))
                       :>_ ;

//process = speaker_chain2(1,16); // test



// --------------------------------------
//  things calculated from decoder config 

// maximum and average speaker distance
r_max = sup(rs);
r_bar = (rs :> float) / float(count(rs));

// number of ambisonic orders, including 0
no = decoder_order+1;

// number of input component signals
nc = count(co);



// the top-level process
process = input_mask(input_full_set):decoder(decoder_type,nc,ns):gain_muting_bus(output_gain_muting,ns);


// End of decoder implementation.  No user serviceable parts above here!
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------

//EOF!
