// Faust Decoder Configuration File
// Written by Ambisonic Decoder Toolbox, version 8.0
// run by henrik_frisk on  (x86_64-apple-darwin17.6.0) at 04-Nov-2018 17:40:58

//------- decoder information -------
// decoder file = ../decoders/KMHLS_FullSetup_7h7v_allrad_5200_rE_max_2_band.dsp
// description = KMHLS_FullSetup_7h7v_allrad_5200_rE_max_2_band
// speaker array name = KMHLS_FullSetup
// horizontal order   = 7
// vertical order     = 7
// coefficient order  = acn
// coefficient scale  = SN3D
// input scale        = SN3D
// mixed-order scheme = HV
// input channel order: W Y Z X V T R S U Q O M K L N P 44S 43S 42S 41S 40C 41C 42C 43C 44C 55S 54S 53S 52S 51S 50C 51C 52C 53C 54C 55C 66S 65S 64S 63S 62S 61S 60C 61C 62C 63C 64C 65C 66C 77S 76S 75S 74S 73S 72S 71S 70C 71C 72C 73C 74C 75C 76C 77C 
// output speaker order: S1 S2 S3 S4 S5 S6 S7 S8 S9 S10 S11 S12 S13 S14 S15 S16 S17 S18 S19 S20 S21 S22 S23 S24 S25 S26 S27 S28 S29 S33 S34 S35 S36 S37 S38 S39 S40 S41 S42 S43 S44 S45 S46 S47 S48 
//-------


// start decoder configuration
declare name "KMHLS_FullSetup_7h7v_full_6";

// bands
nbands = 2;

// decoder type
decoder_type = 2;

// crossover frequency in Hz
xover_freq = hslider("xover [unit:Hz]",400,200,800,20): dezipper;

// lfhf_balance
lfhf_ratio = hslider("lf/hf [unit:dB]", 0, -3, +3, 0.1): mu.db2linear : dezipper;


// decoder order
decoder_order = 7;

// ambisonic order of each input component
co = ( 0, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7);

// use full or reduced input set
input_full_set = 1;

// delay compensation
delay_comp = 1;

// level compensation
level_comp = 1;

// nfc on input or output
nfc_output = 1;
nfc_input  = 0;

// enable output gain and muting controls
output_gain_muting = 1;

// number of speakers
ns = 45;

// radius for each speaker in meters
rs = (          5.13,         5.137,         5.137,         5.134,          5.13,         5.137,         5.137,         5.134,          5.13,         5.137,         5.137,         5.134,          5.13,         5.137,         5.137,         5.134,         5.204,         5.204,         5.204,         5.204,         5.204,         5.204,         5.204,         5.204,         5.321,         5.321,         5.321,         5.321,          5.34,          4.68,          4.67,          4.68,          4.67,          4.68,          4.67,          4.68,          4.67,          4.68,          4.67,          4.68,          4.67,          4.68,          4.67,          4.68,          4.67);

// per order gains, 0 for LF, 1 for HF.
//  Used to implement shelf filters, or to modify velocity matrix
//  for max_rE decoding, and so forth.  See Appendix A of BLaH6.
gamma(0) = (             1,             1,             1,             1,             1,             1,             1,             1);
gamma(1) = (             1,  0.9602898565,  0.8832349127,  0.7734093083,  0.6372937645,  0.4828486811,  0.3189921291,  0.1550188129);

// gain matrix
s(00,0) = (  0.0202876513,  0.0297266425,  0.0149117441,  0.0489643672,  0.0672787334,  0.0210625147,   -0.03726303,  0.0330791768,  0.0352966554,   0.086992999,  0.0491522798, -0.0236162059, -0.0398402772, -0.0410845347,  0.0231808606, -0.0047892942,  0.0763011531,  0.0644314039, -0.0330497962, -0.0346426952,   0.019758352, -0.0556828946, -0.0209879581, -0.0076640474, -0.0509850006,  0.0396892732,  0.0548171542, -0.0298172794, -0.0604132978,  0.0037084573,  0.0462243004,  0.0108019012,  -0.030717129, -0.0043576392, -0.0437132189, -0.0817401973,  -0.006228749,  0.0238455654, -0.0221854551, -0.0642272701,  -0.004008323,  0.0293360895,  0.0053710855,  0.0498502321,  0.0038374786,   0.003734567,  0.0041198601, -0.0658418682, -0.0852388881, -0.0428301398, -0.0127955817, -0.0163001187, -0.0481402596, -0.0095403431,  0.0398677886,  0.0113839811, -0.0300060233,  0.0141663153,  0.0241185979,   0.008221049,  0.0307251851,  0.0075145211, -0.0639407293, -0.0636043208);
s(01,0) = (  0.0148930529,  0.0059429141,  0.0081434539,  0.0426224151,  0.0160147002,  0.0033428676, -0.0312464331,  0.0219085699,  0.0565179216,  0.0279606001,  0.0095417019, -0.0059679969, -0.0240762742,  -0.045125815,   0.030657757,  0.0638153839,  0.0398040799,  0.0176627807, -0.0111106212, -0.0063062445,  0.0268419802, -0.0425202849,  -0.042734201,  0.0364271923,  0.0650335444,  0.0498576274,  0.0264047126, -0.0144749578, -0.0139609149,    0.00334947,  0.0345373881,  0.0298009036, -0.0467133166, -0.0377912048,  0.0384958133,  0.0610103715,  0.0568502469,  0.0343721755, -0.0156335728, -0.0213311542,  0.0040910149,    0.00703315, -0.0127952656,  0.0500550936,  0.0213893429, -0.0465891164, -0.0314903053,  0.0367822747,  0.0529555597,  0.0600270589,  0.0403246766,  -0.014671736, -0.0270150929,  0.0026655202,   0.013012011,  -7.63466e-05,  -0.033919434, -0.0081492144,  0.0469293678,  0.0138617357, -0.0427511681, -0.0249995865,  0.0317872906,  0.0423314916);
s(02,0) = (  0.0203129975, -0.0136027847,  0.0149225192,  0.0557175872, -0.0352983147, -0.0084932597, -0.0373202888,  0.0383132267,  0.0673839922, -0.0581351376, -0.0231709431,  0.0123580171, -0.0398743978, -0.0458414347,  0.0491935112,  0.0650293184, -0.0763213445, -0.0401223022,  0.0210075299,  0.0148774794,  0.0198209925, -0.0639344256, -0.0331500092,  0.0510290049,  0.0511303491, -0.0858984922, -0.0547875372,  0.0242058727,  0.0307223778, -0.0050272478,  0.0462859688,  0.0103474541, -0.0604897674, -0.0181098062,  0.0437689995,  0.0298849904, -0.0852863802, -0.0633743279,  0.0222528419,   0.042788733, -0.0038621549, -0.0145187926,  0.0053198574,  0.0560991706, -0.0039222594, -0.0481396482, -0.0042289395,  0.0297577329,  0.0063727164, -0.0753125736, -0.0638797788,   0.016935605,  0.0481616132,   0.000893903,  -0.024153196, -0.0019634594, -0.0300998522,  0.0180102122,  0.0399851636, -0.0124750069, -0.0308121555,  0.0061100539,  0.0128674736, -0.0145614058);
s(03,0) = (  0.0149006869, -0.0259614057,  0.0081500327,  0.0343477698, -0.0565492067,  -0.013144476, -0.0312660584,  0.0178651291,  0.0159787136, -0.0648756795, -0.0306826239,  0.0277223184, -0.0241021401, -0.0361421774,  0.0095264601, -0.0254269453,  -0.039704409, -0.0382424835,  0.0427717523,  0.0256516793,  0.0268668968, -0.0345562674, -0.0110817388, -0.0133093237, -0.0650788576,  0.0080179275, -0.0263474883,  0.0369579291,  0.0467767003, -0.0187349324,  0.0345959993,  0.0234581943,  -0.013936473,  0.0165464966, -0.0385152206,  -0.078341055,    0.05302289,  0.0017732303,  0.0155823968,  0.0480403007, -0.0214208053,  -0.030503811, -0.0128115069,  0.0404351805,  0.0040771703,  0.0179378514,  0.0315393041, -0.0502563637, -0.0566943261,  0.0723194003,  0.0317821215, -0.0073837278,  0.0269405277, -0.0116997466, -0.0470470136,  0.0057142886, -0.0340205972, -0.0058193791,  0.0129898899, -0.0079463656,  0.0428083363,  0.0280555321, -0.0401983275, -0.0123371063);
s(04,0) = (  0.0203036796, -0.0489911445,   0.014932782,  0.0297635795, -0.0673457792, -0.0331161994, -0.0372782784,  0.0211000418, -0.0352806522, -0.0048662371, -0.0492256193,  0.0410798776, -0.0398819709, -0.0236276347, -0.0231810879, -0.0870443694,  0.0762928762, -0.0077241684,   0.033044276,  0.0557176747,  0.0197401109, -0.0346850508,   0.020965751,   -0.06449898, -0.0510956928,  0.0818330135,  0.0548342357, -0.0043437365,  0.0604594021, -0.0107702131,  0.0462425418,   0.003689568,  0.0307044517,  0.0297898495, -0.0438127642,  0.0396139077,  0.0063384872,  0.0659340427, -0.0221535056,  0.0037734961,  0.0040380954,  -0.049845004,   0.005393944,   0.029344067, -0.0038267896,  0.0642393741,  0.0041110101,  0.0238017703,  0.0852753344, -0.0635830886,  0.0128728822, -0.0074886934, -0.0481166481,  0.0082284643,  -0.039855634, -0.0141738384, -0.0299898719,  0.0113909893, -0.0241031174,  0.0095517208,  0.0307503875, -0.0162808806,  0.0639918457,  0.0429269659);
s(05,0) = (  0.0148720972, -0.0425610559,  0.0081455726,   0.005935845, -0.0159944454,  -0.021911849, -0.0311960309,  0.0033472354, -0.0564357786,  0.0637235413, -0.0095516923,  0.0450483902, -0.0240773989, -0.0059519672, -0.0306573971, -0.0279246224,  0.0397544958,  0.0364189397,   0.011072909,  0.0425183805,  0.0267921491, -0.0063062282,  0.0426627792, -0.0176771548,  0.0649433079, -0.0609317018,  0.0264205903, -0.0377395634,  0.0139531109, -0.0297501869,  0.0345374378,    0.00333103,  0.0467094376,  0.0144154927,   0.038476119,  0.0498015347, -0.0567991122, -0.0367489014, -0.0155577379, -0.0465880539, -0.0040612035, -0.0500658746,  -0.012781703,  0.0070229806, -0.0213688387,   0.021307872, -0.0314708641,  0.0343861705, -0.0528951714,  0.0422911555, -0.0403340245,  0.0250212537, -0.0269709236,  0.0138754286, -0.0129872985,  0.0081648411, -0.0339485075,  -7.19521e-05, -0.0469608606, -0.0026372886, -0.0427600275, -0.0145889016, -0.0317393956, -0.0599951324);
s(06,0) = (  0.0203344124, -0.0557793555,  0.0149185453, -0.0136150345,  0.0353310083, -0.0383059675, -0.0373734074, -0.0084833896, -0.0674619682,  0.0651064369,  0.0231471467,  0.0459248512, -0.0398615201,  0.0123815399, -0.0491969498,  0.0581870985, -0.0763807954,  0.0510563638, -0.0210585976,  0.0639153285,  0.0198919441,   0.014860421,  0.0332188452,  0.0400893913,  0.0511920067, -0.0299252224, -0.0547572105, -0.0181372631, -0.0306899465, -0.0104456286,   0.046266295, -0.0050640389,  0.0604772163, -0.0242728887,  0.0438266557, -0.0859459468,  0.0853014365, -0.0298413465,  0.0223097094, -0.0481317073,  0.0039328447, -0.0560714812,  0.0052381773, -0.0145041532,  0.0038539569, -0.0427465191,  -0.004198579, -0.0633593717, -0.0063980953, -0.0145325863,  0.0638877554, -0.0061939382,  0.0481127248, -0.0124540861,  0.0241306097, -0.0179053104,  -0.030081546, -0.0019201501, -0.0399541086, -0.0008093239, -0.0307991599,  0.0169516424, -0.0129632231,   0.075282293);
s(07,0) = (  0.0149042737, -0.0343635258,  0.0081851202, -0.0259481273,  0.0565367609, -0.0179465403, -0.0312413917, -0.0131865985, -0.0160292482, -0.0253480985,  0.0307903503,  0.0360911441,  -0.024186316,  0.0276617423, -0.0096018156,  0.0649076338, -0.0398002373, -0.0132924395, -0.0426540179,  0.0346747409,  0.0267662068,  0.0257042837,   0.011077795,  0.0384092354, -0.0650254364,  0.0783650576, -0.0265238326,   0.016469103,  -0.046873431, -0.0233111653,  0.0346641184, -0.0186178833,  0.0140306838,  -0.036838918, -0.0386001582,  0.0079017691, -0.0529615467,  0.0504375702,  0.0155220599,  0.0178872089,  0.0212214885, -0.0404983534, -0.0126543125, -0.0305076205, -0.0040178921, -0.0481716609,  0.0314041088,  0.0016684776,  0.0567832118, -0.0124132317, -0.0318088151, -0.0279203334,  0.0270832383, -0.0078902362,  0.0470390593,   0.005638916, -0.0340069006,  0.0055906339, -0.0130571422,  0.0115049473,  0.0428250236, -0.0073674172,  0.0403986696, -0.0723418456);
s(08,0) = (  0.0203014626, -0.0297484774,  0.0149227358, -0.0489939637,  0.0673240361, -0.0210804279, -0.0372758714, -0.0330963363,  0.0353120556, -0.0870467284,  0.0491853791,  0.0236157169, -0.0398498325,  0.0410878561,  0.0231794435,  0.0048022951,  0.0763445462, -0.0644612016, -0.0330362603,   0.034645652,   0.019746963,  0.0556739706, -0.0209914146,  0.0076935432, -0.0510255253, -0.0397107695,  0.0548242732,   0.029798078, -0.0603951792,  -0.003692084,  0.0461924458, -0.0107898712, -0.0306949208,  0.0043782911, -0.0437628665,  0.0817962428, -0.0062293195, -0.0238222007,  -0.022178793,  0.0641847682, -0.0040264404, -0.0292989723,  0.0053708502, -0.0497870855,  0.0038458904, -0.0037437271,  0.0040796732,    0.06589286, -0.0852965652,  0.0428452474,  -0.012843054,  0.0163181999, -0.0480930869,  0.0095422804,  0.0397906686, -0.0113737557,  -0.029941034, -0.0141400561,  0.0240809256, -0.0082417452,  0.0307052069, -0.0074678696, -0.0639751883,  0.0636563107);
s(09,0) = (  0.0148902343, -0.0059353064,  0.0081684842, -0.0426095995,  0.0159924474, -0.0033505019, -0.0312125282, -0.0219700142,  0.0564990369, -0.0279212812,  0.0095601818,  0.0059447804, -0.0241286036,  0.0450445976,  0.0307363241, -0.0637975156,  0.0397516545, -0.0176913956, -0.0110519412,  0.0063091683,  0.0267527554,  0.0425884624, -0.0426323537, -0.0365129098,  0.0650252007, -0.0498026051,  0.0264399573,  0.0143769987, -0.0139553346, -0.0033124104,  0.0345639896, -0.0296557175, -0.0467649312,  0.0376880531,  0.0385799639, -0.0610181894,  0.0568081096, -0.0344095631,   -0.01550261,  0.0213041582,  0.0040171075, -0.0070177285, -0.0126893908, -0.0500592432,    0.02125487,  0.0466218684, -0.0314064198, -0.0368587347,  0.0529812618, -0.0600151607,  0.0403606405,  0.0145228579, -0.0269568265, -0.0025683628,  0.0129668839,   4.34846e-05, -0.0338966952,  0.0080289203,  0.0469097856, -0.0137641847, -0.0427703444,  0.0249514688,   0.031852776, -0.0423698184);
s(10,0) = (  0.0203095769,  0.0136255609,  0.0148981946, -0.0557105013, -0.0353527126,  0.0085057102,  -0.037343439, -0.0382550281,  0.0673673993,  0.0582116396, -0.0232035346, -0.0123769457, -0.0398291375,  0.0459052786,  0.0491209223,  -0.064992923, -0.0763970327,   0.040177372,  0.0210333951, -0.0148908033,  0.0199059629,  0.0638840932, -0.0332217653,   -0.05095099,  0.0510720759,  0.0859477638, -0.0548616474, -0.0242158328,  0.0307415446,  0.0050440884,  0.0462854796, -0.0104845211, -0.0604571056,  0.0181629745,  0.0436932652, -0.0298178217, -0.0852939025,  0.0634598874,  0.0222188695, -0.0427979148, -0.0038911844,  0.0145262625,  0.0052146282, -0.0561435247, -0.0038109947,  0.0481151485, -0.0042472606, -0.0296917227,  0.0063237113,  0.0752829267, -0.0639685792, -0.0168350627,  0.0481385613, -0.0008624099, -0.0241617115,  0.0019342133, -0.0301763561, -0.0179006092,  0.0400441685,  0.0124172877, -0.0307817667, -0.0061249057,  0.0128190878,  0.0145601463);
s(11,0) = (  0.0149297476,  0.0260005299,  0.0081851138, -0.0344149469, -0.0566367525,  0.0131913361, -0.0312940556, -0.0179393455,  0.0160282884,  0.0649905646,  -0.030790567, -0.0277165373, -0.0241737707,  0.0361467855,  0.0095778079,  0.0254303502,  -0.039803916,  0.0383864084,  0.0427302491, -0.0256970666,  0.0268206519,  0.0346351501, -0.0110821249,  0.0133281747, -0.0651474564, -0.0079773525, -0.0264707191, -0.0368922423,  0.0468334065,   0.018666815,  0.0346178079, -0.0233742116, -0.0139758225, -0.0165080438,    -0.0386246,  0.0784502908,  0.0530529906, -0.0017346612,  0.0155359081,  -0.048084817,  -0.021296824,  0.0304742368, -0.0127222222, -0.0404128623,  0.0040485772, -0.0179233827,  0.0314474565,  0.0504299377,   -0.05678957, -0.0723809076,  0.0318610509,  0.0073695499,  0.0269726843,  0.0115868375, -0.0469544424,   -0.00564613, -0.0339324453,  0.0057375172,  0.0129821149,  0.0078914381,  0.0428019088, -0.0279355157, -0.0403637792,  0.0123711476);
s(12,0) = (  0.0202986639,  0.0489923479,   0.014920154, -0.0297393029, -0.0673100326,  0.0331008038, -0.0372808327, -0.0210673405, -0.0353218881,  0.0047816266, -0.0491700508, -0.0411001104, -0.0398567382,  0.0236298991, -0.0232096182,  0.0870362475,  0.0763396433,  0.0076396624,  0.0330664798, -0.0557043878,  0.0197696416,  0.0346489985,  0.0209819769,  0.0644680535, -0.0509991746, -0.0817648306,  0.0548660217,  0.0043336895,  0.0604249094,  0.0108093331,  0.0462350441, -0.0037244634,  0.0307295415, -0.0298149075, -0.0437076112, -0.0397088035,  0.0062273232,  -0.065858074, -0.0221532651, -0.0037344174,  0.0039888306,  0.0498568212,  0.0053534993, -0.0293452122, -0.0038279616, -0.0642322658,  0.0041368571, -0.0238897626,  0.0852551238,  0.0636016091,  0.0127676734,  0.0074993483, -0.0481276271, -0.0082020879, -0.0398777157,  0.0141391593, -0.0300172267,  -0.011364239, -0.0241082297, -0.0095308729,  0.0307230804,  0.0162547105,  0.0639661897, -0.0428306102);
s(13,0) = (  0.0148886632,   0.042609771,  0.0081499261,  -0.005934559, -0.0159919728,  0.0219269798, -0.0312380161, -0.0033394118, -0.0565004308, -0.0637939791, -0.0095313327,  -0.045114824, -0.0240994506,  0.0059588126, -0.0306850291,  0.0279206535,  0.0397471904, -0.0364616325,   0.011092877, -0.0425673398,  0.0268378707,  0.0062987228,  0.0427248834,   0.017642417,  0.0650088248,  0.0609824698,  0.0263721416,  0.0377840413,  0.0139428833,  0.0298001974,  0.0345853244, -0.0033443446,  0.0467728389, -0.0144509664,  0.0385348606, -0.0497872167, -0.0567726431,  0.0368229947, -0.0156066399,  0.0466577218, -0.0040859789,  0.0501421816, -0.0127994819, -0.0070241647, -0.0213931698,  -0.021300577, -0.0314855458, -0.0343265798, -0.0529237666,  -0.042293774,  -0.040267154, -0.0249973311, -0.0269706494, -0.0138692634, -0.0129948206, -0.0081591668, -0.0339999511,   7.87002e-05, -0.0470312822,  0.0026659915, -0.0428246961,  0.0146453736, -0.0318267196,  0.0599508239);
s(14,0) = (  0.0203153676,  0.0557234726,  0.0149231509,  0.0136076102,  0.0353080598,  0.0383137055, -0.0373244241,  0.0084990056, -0.0673896372, -0.0650328672,  0.0231838746, -0.0458484926, -0.0398704076, -0.0123535537, -0.0491949318, -0.0581459867, -0.0763272656, -0.0510348204, -0.0209918915, -0.0639247952,  0.0198317639, -0.0148728828,  0.0331585458, -0.0401429034,  0.0511321124,  0.0298884063, -0.0548174466,  0.0181184073, -0.0307021625,  0.0103732596,  0.0462731997,    0.00502361,  0.0604848725,  0.0241748414,  0.0437823756,  0.0858933326,  0.0852663267,  0.0297787927,  0.0222034835,  0.0481491107,  0.0038646844,  0.0560855404,  0.0052844367,  0.0144970842,  0.0038927627,  0.0427492588, -0.0042356736,  0.0634163836, -0.0063843253,  0.0145333501,  0.0639361948,  0.0061051247,  0.0481078208,  0.0124551531,  0.0241099851,  0.0179460958, -0.0300965861,  0.0019421338, -0.0399872731,  0.0008778539, -0.0308404135, -0.0168659112, -0.0128918152, -0.0752783499);
s(15,0) = (  0.0148994292,  0.0343460338,  0.0081661475,   0.025954395,  0.0565404715,  0.0179006817,  -0.031246582,  0.0131673502, -0.0159879344,  0.0254110277,  0.0307412214, -0.0361051986, -0.0241376265, -0.0276900378, -0.0095517761, -0.0648815482, -0.0397261345,  0.0133293988, -0.0427061522, -0.0346007798,  0.0268102907, -0.0256772406,  0.0110675995, -0.0383296815, -0.0650780305,  -0.078366721, -0.0264212027, -0.0165152963, -0.0468227817,  0.0233780416,  0.0346130685,  0.0186765559,  0.0139633487,  0.0368831765, -0.0386094387, -0.0080050057, -0.0530433115, -0.0504092451,  0.0155320761, -0.0179426318,  0.0213193536,  0.0404374877, -0.0127375418,  0.0304964246, -0.0040392639,   0.048100045,  0.0314621727, -0.0017815708,   0.056724715,  0.0123350934, -0.0319166029,  0.0279536853,  0.0269906704,  0.0079240192,  0.0470245327, -0.0057412654, -0.0339845053, -0.0056671696, -0.0129956674,  -0.011589791,  0.0428599309,  0.0073802201,  0.0403289292,  0.0723617544);
s(16,0) = (  0.0380113964,   0.070419014,  0.0713918737,  0.0407315152,  0.0693638888,  0.1222457219,  0.0240182792,  0.0677860839, -0.0373808763,  0.0052889348,  0.1202940882,  0.0935748742, -0.0549737819,  0.0452741779, -0.0702121629, -0.0629687609, -0.0339781804,  0.0041447818,  0.1048635136,  0.0042336205,  -0.087137983, -0.0101589563, -0.0730023885, -0.1145065529,  -0.028000909, -0.0258053026, -0.0649420653, -0.0074006325,  0.0300904762, -0.0655011808, -0.0497667574, -0.0467974348, -0.0418104989, -0.1149785892, -0.0475368101,  0.0063944604, -0.0056906066, -0.0455762206, -0.0724562328, -0.0228719217, -0.0380987427, -0.0646782725,  0.0086491184, -0.0367076916, -0.0027948387, -0.0599982095, -0.0408313458,  0.0141543259,  0.0118585819,  0.0010690882, -0.0089648273, -0.0430295298,  -0.049596291, -0.0288682343, -0.0476836928, -0.0186547461,  0.0310292001, -0.0022791012,  0.0160355796,  0.0027278712,  -0.009042841,  0.0196674581,  0.0201999834,   0.003992671);
s(17,0) = (  0.0306211721,  0.0165528978,  0.0533641272,  0.0680427388,  0.0322919601,  0.0281496081,  0.0055090701,  0.1100413943,  0.0644991987,  0.0382097096,  0.0575037652,  0.0195675694, -0.0632949428,  0.0646973498,  0.1082953167,  0.0476979946,   0.034112063,  0.0710481213,  0.0522810729, -0.0043342603, -0.0796734396, -0.0360441318,  0.0857310059,  0.0823037237,  0.0288213666,  0.0241925087,  0.0651287086,  0.0736520786,  0.0161927434, -0.0229097822, -0.0286063887, -0.0983916684,  0.0073126749,  0.0730781424,  0.0496698087,  0.0142086405,   0.013214867,  0.0463063492,  0.0721825243,  0.0399092709, -0.0220910275,   -0.02171169,  0.0352789981, -0.0718268151, -0.0588443982,  0.0219373874,  0.0445928423,  0.0234402874,   0.005572447,  0.0043099839,    0.02433147,  0.0520224341,   0.047764574, -0.0039529198, -0.0343596535, -0.0059091688,  0.0532762818,  0.0020074827, -0.0610973804, -0.0273803263,  0.0142335166,  0.0186796467,  0.0083576985,  0.0017626132);
s(18,0) = (  0.0380027528, -0.0407191393,  0.0713844673,  0.0704004065, -0.0693433587, -0.0677757394,  0.0240351947,  0.1222313142,  0.0373720446, -0.0629532425,  -0.120279476, -0.0452842568, -0.0549494325,   0.093594237,  0.0702060563, -0.0052855645, -0.0339714246, -0.1145005822, -0.1048835318,  0.0101406967, -0.0871444725,    0.00427196,  0.0730098208, -0.0041402097, -0.0279964217, -0.0063845551, -0.0649483251, -0.1150033816, -0.0301294196,  0.0468061078, -0.0498054949, -0.0654904461,  0.0418250012,  0.0073981733, -0.0475339858, -0.0258060421,  0.0057154739, -0.0141559408, -0.0724837145, -0.0600350292,  0.0380934697,  0.0367534304,  0.0086214017, -0.0647074595,  0.0028026773,  0.0228570139, -0.0408406081, -0.0455837682, -0.0118532867,  0.0040253051,  0.0089884206, -0.0196905761, -0.0496195507,   0.002724095,  0.0477331219,  0.0023283465,  0.0310411058, -0.0186830465, -0.0160305833,   0.028852915,  -0.009066206, -0.0430453859,  -0.020202636, -0.0010394667);
s(19,0) = (  0.0306312963, -0.0680621922,  0.0533828762,  0.0165509432, -0.0322841511, -0.1100701746,  0.0055179064,  0.0281504572, -0.0645165278,   0.047710903, -0.0574916937, -0.0647155286,  -0.063298276,  0.0195817778, -0.1083150329,  -0.038201093,  0.0341125397,  0.0823168235, -0.0522847148,  0.0360363366, -0.0796805965, -0.0043025155, -0.0857314762, -0.0710226443,  0.0288228626, -0.0141870746,  0.0651072837,  0.0730683492,  -0.016235549,  0.0983791425, -0.0286201538,  -0.022877381, -0.0072948365, -0.0736226933,  0.0496741521,  0.0242062654, -0.0132350418, -0.0234192299,  0.0721308781,  0.0218945635,  0.0220186033,  0.0718143881,  0.0352482272, -0.0217096411,  0.0588531321, -0.0399134826,  0.0445908815,  0.0463063324, -0.0055200598,  0.0016841637, -0.0243517164, -0.0186830522,  0.0477128464, -0.0274338335,  0.0343112557, -0.0019915115,  0.0532387201, -0.0059492013,   0.061079201,  0.0038959339,  0.0142063902,  0.0519818646, -0.0082907334, -0.0043230131);
s(20,0) = (  0.0379997646, -0.0703880089,  0.0713776112, -0.0407267604,  0.0693578668, -0.1222077831,  0.0240365217, -0.0677757203, -0.0373438941, -0.0053327195,  0.1202824868, -0.0935813031,   -0.05492177, -0.0452666239,  -0.070170792,  0.0629598014, -0.0339556414, -0.0041961758,  0.1048542385, -0.0042976118, -0.0870954621,  0.0101488086, -0.0730057935,  0.1145043437,  -0.028043554,  0.0258259928, -0.0649326731,  0.0073937599,   0.030094397,  0.0654308893, -0.0497773262,  0.0467665729, -0.0418617262,   0.114995571, -0.0476029636, -0.0063608405, -0.0057107457,  0.0456294265, -0.0724905496,   0.022916586, -0.0380804087,  0.0646637437,  0.0085917635,  0.0366770872, -0.0028365853,  0.0600184567, -0.0408780793, -0.0141228723,  0.0118493611, -0.0010524529, -0.0089926017,  0.0431038395, -0.0496474751,  0.0289086723, -0.0476628147,  0.0186989043,  0.0309776688,  0.0022764781,  0.0160516814, -0.0027401029, -0.0090375374, -0.0196771955,  0.0202108791, -0.0039789159);
s(21,0) = (  0.0306194443, -0.0165485808,  0.0533547184, -0.0680444218,  0.0322900754, -0.0281370846,  0.0054927342, -0.1100303216,   0.064507223, -0.0382186252,  0.0574860077, -0.0195536035, -0.0632990924,  -0.064664791,  0.1082990353, -0.0477018332,  0.0341291725, -0.0710436141,  0.0522494327,  0.0043294913, -0.0796478534,  0.0360756327,  0.0857158385, -0.0823121754,   0.028806552, -0.0242044613,  0.0651420285,  -0.073623974,  0.0161830178,  0.0228765763, -0.0285649984,   0.098387017,  0.0072811964, -0.0730872421,  0.0496561924, -0.0141708322,  0.0132090589, -0.0463189826,  0.0721771649, -0.0398902927, -0.0220450153,  0.0216753148,  0.0353003834,  0.0717836933, -0.0588720264, -0.0219356335,  0.0446006977,  -0.023387818,  0.0055229197, -0.0042851617,  0.0243190901, -0.0520309892,  0.0477609736,  0.0039156259, -0.0342833638,  0.0059115425,  0.0532636724, -0.0020531431, -0.0611036996,  0.0274052358,  0.0142592672,  -0.018654249,  0.0082788931, -0.0017207385);
s(22,0) = (  0.0380205423,  0.0407218497,  0.0714204721, -0.0704326307, -0.0693497977,  0.0677810795,   0.024061545,  -0.122280171,   0.037406373,  0.0629670619, -0.1202847842,  0.0452942272, -0.0549330057, -0.0936234551,  0.0702544345,  0.0052570658,  -0.033988067,  0.1145119819, -0.1048814014, -0.0101173395, -0.0871128571, -0.0042768678,  0.0730334571,  0.0041004887, -0.0279814211,  0.0063982584, -0.0649565738,  0.1149951402, -0.0301308292, -0.0467594429, -0.0497477793,  0.0654707314,  0.0418077036, -0.0074199701, -0.0475157279,   0.025804004,  0.0057046413,  0.0141475218, -0.0724628441,  0.0600143991,  0.0380636877, -0.0366858209,  0.0086795263,  0.0646367869,  0.0027691413, -0.0228463421, -0.0408334768,  0.0455812762, -0.0118622002, -0.0040182975,  0.0090084713,  0.0196379516, -0.0495856861, -0.0027275518,  0.0476631765, -0.0022582491,  0.0310612054,  0.0185706614, -0.0160448679, -0.0288190323, -0.0090734611,  0.0430450959, -0.0202025923,  0.0010625246);
s(23,0) = (  0.0306213415,  0.0680327787,  0.0533733621, -0.0165659805, -0.0323141482,  0.1100449557,  0.0055321232, -0.0281700179, -0.0644711985, -0.0476547056, -0.0575361199,  0.0647337729,  -0.063280135, -0.0195808404, -0.1082721746,  0.0382310846,  0.0341263426, -0.0822563324, -0.0523026014, -0.0360026023, -0.0796899077,  0.0043325257, -0.0857463736,  0.0710744506,  0.0287723143,  0.0141639551,  0.0651396452, -0.0730710239, -0.0161994439, -0.0983884454, -0.0286394659,  0.0229110829, -0.0073486038,  0.0736611016,  0.0496143874, -0.0241993531, -0.0132177457,  0.0233929709,  0.0721699446, -0.0219601698,   0.022082188, -0.0718538044,   0.035264581,  0.0217115888,  0.0588363906,  0.0399014256,  0.0445818741, -0.0463056711, -0.0055388418, -0.0017424924, -0.0243298221,  0.0186814992,  0.0477321406,  0.0273828937,  0.0343407392,   0.002000077,  0.0532825866,  0.0059160255,  0.0611184467, -0.0039512311,  0.0142616617, -0.0519995263,  -0.008325815,  0.0043127755);
s(24,0) = (  0.0343548857,  0.0398818491,   0.088532239, -0.0151160013, -0.0138234886,  0.0947999705,  0.1063573938, -0.0365986826,  -0.016917791, -0.0038678002, -0.0346706227,  0.1384719347,  0.0837237586, -0.0552506736, -0.0417347168,  0.0062344826,  0.0003698866, -0.0099615418, -0.0569065497,  0.1489226551,  0.0350328351, -0.0629406631, -0.0666975672,  0.0162757812, -0.0002833052, -0.0003434239,  0.0008978669, -0.0168980558,  -0.071325132,  0.1219692379, -0.0156507747, -0.0573345686, -0.0800269434,  0.0281649282, -0.0007866444,  0.0018380652,  0.0015313633, -0.0009431515,  0.0013063156, -0.0216072564, -0.0717929141,  0.0718993155, -0.0475891518, -0.0423802358, -0.0746357806,  0.0371160861, -0.0014685183,  0.0053892754, -0.0002684185, -0.0003231493,  0.0046679911, -0.0017050992,  0.0010312278, -0.0214214201, -0.0586536774,  0.0220836091, -0.0530515934, -0.0254600101, -0.0523673162,  0.0386507558, -0.0021115942,  0.0107613147, -0.0008531697, -0.0005111153);
s(25,0) = (  0.0343682304,  0.0151120816,  0.0885702172,  0.0398855512,  0.0138143112,  0.0365897044,   0.106411387,  0.0948148679,  0.0169033884,  0.0062242632,  0.0346489343,  0.0552367398,  0.0837755844,  0.1385059836,  0.0417001364,  0.0038560681,  0.0003674145,  0.0162470501,  0.0568732256,  0.0629197616,  0.0350592412,  0.1489741388,  0.0666431309,  0.0099293989, -0.0002875658, -0.0018336099,  0.0008868812,  0.0281110438,  0.0712848753,  0.0572999548, -0.0156643545,  0.1220212334,  0.0799597208,  0.0168388667, -0.0007991993, -0.0003442998, -0.0015253681, -0.0053798243,  0.0012778684,  0.0370388166,  0.0717489676,  0.0423228934, -0.0476347217,  0.0719279052,  0.0745640498,  0.0215227966, -0.0014928806, -0.0009460899,  0.0002700275, -0.0005054942,  -0.004651405, -0.0107495083,  0.0009799543,  0.0385624516,  0.0586032651,  0.0253763919, -0.0530981595,  0.0220768927,  0.0522956658,  0.0213235857, -0.0021465635, -0.0017109121,  0.0008561812,  0.0003282904);
s(26,0) = (  0.0343613365, -0.0398955896,  0.0885481856,  0.0151123496, -0.0138333298, -0.0948298604,   0.106375245,  0.0365866404, -0.0169290993,  0.0038815699, -0.0346910407, -0.1385113125,  0.0837373991,  0.0552231536, -0.0417516503,  -0.006253105,  0.0003978409,  0.0099851135, -0.0569313709, -0.1489640423,  0.0350416611,  0.0628889604,  -0.066701711, -0.0163111941, -0.0002741231,  0.0003478424,  0.0009568387,  0.0169116394, -0.0713438612, -0.1220141159, -0.0156424137,   0.057250342, -0.0799987796, -0.0281986283, -0.0007648927, -0.0018129147,  0.0015219953,   0.000951656,  0.0013762604,  0.0215805808, -0.0717983335, -0.0719585712, -0.0475759077,  0.0422589233, -0.0745752742, -0.0371189718, -0.0014357328,  -0.005329402, -0.0002576118,  0.0003193152,  0.0046429574,  0.0017114618,  0.0010679193,  0.0213348782, -0.0586459164, -0.0221671242, -0.0530305496,  0.0253052223, -0.0523026894, -0.0386067184, -0.0020763011, -0.0106728164, -0.0008255007,   0.000516457);
s(27,0) = (  0.0343735455, -0.0151262899,  0.0885795459, -0.0398976973,  0.0138334818,  -0.036619387,  0.1064117692, -0.0948377101,  0.0169098118, -0.0062378497,  0.0346896853, -0.0552722961,  0.0837617606, -0.1385268253,  0.0417159904, -0.0038529319,  0.0003730574, -0.0162765489,  0.0569259883, -0.0629501919,  0.0350411523, -0.1489803931,  0.0666691854, -0.0099259281, -0.0002950338,  0.0018331738,  0.0008994412, -0.0281500428,  0.0713340306, -0.0573247081, -0.0156685313,  -0.122013476,  0.0799940803, -0.0168425293, -0.0008129754,  0.0003521285, -0.0015278881,  0.0053785428,  0.0012941545, -0.0370735597,  0.0717891344,  -0.042353748,   -0.04761439, -0.0719209193,  0.0746044496, -0.0215419098, -0.0015045161,  0.0009625407,  0.0002627956,  0.0005105288, -0.0046575846,  0.0107476759,  0.0009909308, -0.0385840605,  0.0586481832, -0.0254267497, -0.0530605591, -0.0220866188,  0.0523416568, -0.0213596151,  -0.002142852,  0.0017302128,   0.000839036,  -0.000321714);
s(28,0) = (  0.0116283448,   1.24741e-05,  0.0343458244,   -6.0311e-06,    1.0774e-06,   3.40799e-05,  0.0554784962,  -1.62779e-05,    5.2644e-06,    2.5671e-06,     3.019e-06,    6.2012e-05,  0.0740768677,  -2.90406e-05,    1.5711e-05,    1.6007e-06,    3.4549e-05,    8.3847e-06,     5.741e-06,   9.16366e-05,  0.0893439408,  -4.16646e-05,    3.2799e-05,    5.0616e-06,  -1.79769e-05,    -2.251e-07,  0.0001214182,   1.94716e-05,    8.6205e-06,  0.0001178428,   0.100680734,  -5.13014e-05,   5.64034e-05,   1.12709e-05,  -6.31888e-05,     -5.31e-08,      5.29e-08,    -8.233e-07,  0.0003048564,   3.74529e-05,   1.06448e-05,  0.0001357823,  0.1077178359,  -5.53778e-05,   8.52212e-05,   2.05631e-05, -0.0001586891,    -1.924e-07,     -8.19e-08,      1.23e-08,     2.114e-07,   -2.1436e-06,   0.000634287,   6.34777e-05,   1.05531e-05,  0.0001415785,  0.1103310052,  -5.20368e-05,  0.0001168735,   3.26439e-05, -0.0003302608,    -4.954e-07,    -3.197e-07,      -4.3e-08);
s(29,0) = (  0.0332831817,  0.0555503148, -0.0381102487,  0.0645700365,  0.1048690719, -0.0532736038, -0.0265088273, -0.0620446584,  0.0158079615,  0.0987097394, -0.0971789744, -0.0074881662,  0.0450774983, -0.0085648378, -0.0148663455, -0.0620865798,  0.0350446644, -0.0898425313,  0.0063303526,  0.0286736198,   0.001936095,  0.0334163724,  0.0011899018,  0.0560472878, -0.1141657034, -0.0467226798, -0.0316869882,  0.0155677416,   0.026006109,  0.0051470624, -0.0209533527,  0.0058263137,   0.004031449, -0.0093053256,  0.1012374881, -0.1062619797, -0.0974523154,  0.0396430944,  0.0078331896,  0.0097967519,  0.0156686874, -0.0171383985, -0.0079192962, -0.0200341882,  0.0021496719, -0.0059855118, -0.0234540252,  0.0920671157, -0.0463186739, -0.0926320527,  0.0806440254, -0.0101492426,  0.0001048872,  0.0197527948, -0.0264451336,  -0.006514367,  0.0163014288,  -0.007363788, -0.0041442042, -0.0127894459,  0.0002258281, -0.0250397778,  0.0393413063,  0.0256598924);
s(30,0) = (  0.0332647088,  0.0268499126, -0.0381096993,    0.08078344,  0.0634545018, -0.0257474565, -0.0264804254, -0.0776333391,   0.084898323,  0.0956609038, -0.0587526628, -0.0036296079,  0.0451147814, -0.0107201437, -0.0788537639,  0.0665692557,  0.1144768895, -0.0867879574,  0.0037560649,  0.0138674908,   0.001857136,  0.0418484933,  0.0053189274, -0.0607248423,  0.0337890751,  0.1159641439, -0.1016573532,  0.0147564888,  0.0157376142,  0.0024989598, -0.0209583013,  0.0072290512,  0.0211450639,  0.0106592695, -0.0304322423, -0.0039237372,  0.1011671899, -0.1002355296,  0.0236203409,  0.0094267947,   0.009534999, -0.0083012779, -0.0078491028, -0.0250012011,  0.0124823256,  0.0066133324,  0.0074699147,  0.0028406695,   -0.03743958,  0.0750580828, -0.0844240122,  0.0270286208, -0.0001458636,  0.0193693059, -0.0159828738,   -0.00313426,  0.0162810562, -0.0092401714, -0.0214404089,  0.0132273216,  -1.97834e-05, -0.0002827202,  0.0305146829, -0.0600452987);
s(31,0) = (  0.0332889547, -0.0063592984, -0.0381259428,   0.084942507, -0.0157546839,  0.0062100437, -0.0264770764, -0.0815456862,  0.1048784839, -0.0257988961,  0.0148861251,  0.0007226657,  0.0450250749,  -0.011327129,   -0.09716551,  0.1137278704, -0.0349027779,  0.0239244688, -0.0012863905,  -0.003356175,  0.0019850128,  0.0438336024,  0.0063173566, -0.1031383375,  0.1142230754, -0.0419244184,  0.0317168973, -0.0045808915, -0.0040121705,  -0.000420682, -0.0209773321,  0.0078482879,  0.0259678913,  0.0175372694,  -0.101217226,  0.1082692269, -0.0461253589,  0.0370993552, -0.0080237313, -0.0026438101, -0.0020539666,    0.00200723, -0.0079021631, -0.0263624183,  0.0157399228,  0.0111572348,  0.0233705606, -0.0931211551,  0.0975778841, -0.0471661687,  0.0393739838,  -0.010732228,  -3.21468e-05, -0.0048225806,  0.0040693966,  0.0005906844,   0.016286794, -0.0097170959, -0.0265128727,  0.0230602355, -0.0001971831,  0.0247765388, -0.0806435914,  0.0837918713);
s(32,0) = (  0.0332731055, -0.0381565154, -0.0380812403,  0.0761405648, -0.0849507963,  0.0366610224, -0.0265425548, -0.0730624673,  0.0634803441, -0.1147884329,  0.0787972311,  0.0050690269,  0.0450985191, -0.0102268551, -0.0587368263,  0.0205600427, -0.1145386578,  0.1042477044,  -0.005207505, -0.0197588425,  0.0019129854,  0.0393667778,  0.0037265245, -0.0184523554, -0.0338501133, -0.0847848977,  0.1016226001, -0.0178566173, -0.0211169126, -0.0034212516, -0.0209121193,   0.006955595,  0.0157191005,  0.0029530738,  0.0303807618, -0.0793166318, -0.0373867859,  0.0728868431, -0.0235661045, -0.0113154798, -0.0125820705,  0.0118153479, -0.0079369709, -0.0235109031,  0.0095500337,  0.0019706499, -0.0073497942,  0.0688139786, -0.1012445611,  0.0107072086,  0.0305416252, -0.0193482572,  0.0001782877, -0.0231229763,  0.0214282769,  0.0043340664,  0.0162784535, -0.0088121206, -0.0159424137,  0.0043138138,    6.7662e-06,  -0.018790212,  0.0843894927, -0.0955482518);
s(33,0) = (  0.0332842348, -0.0645600038, -0.0381483656,  0.0555341243, -0.1048360638,  0.0620924992, -0.0264363737, -0.0532952533,  -0.015813225, -0.0620584984,  0.0972184028,  0.0084727717,  0.0450568161, -0.0074275551,    0.01490477, -0.0986852777,  0.0350438475,  0.0560261029, -0.0064292795, -0.0333904959,  0.0019036509,  0.0286485254, -0.0012416939,   0.089895163, -0.1141380072,  0.1062578774, -0.0317420406, -0.0092974079, -0.0259619784, -0.0057835088,  -0.020965126,  0.0051312152, -0.0040183064, -0.0156673845,  0.1012421013, -0.0467191523,  0.0974777543, -0.0920951387,  0.0079148412, -0.0059872425, -0.0156583871,  0.0200301062, -0.0078509933, -0.0171480294, -0.0021197685, -0.0097517875, -0.0234702225,  0.0396039239,   0.046326099,  0.0256840556,  -0.080631346,  0.0250610876,   5.95359e-05, -0.0128132372,  0.0264737207,  0.0073046824,  0.0162568243, -0.0064763583,  0.0041158622, -0.0197454276,  0.0002265196, -0.0100803718, -0.0393743037,  0.0926901787);
s(34,0) = (  0.0332721145, -0.0808115465, -0.0380982391,  0.0268356944, -0.0634323723,  0.0776089425, -0.0265039155, -0.0257158291, -0.0849547031,  0.0666567254,   0.058691351,  0.0107694785,  0.0450804278, -0.0036500516,  0.0788433113, -0.0956472913,  0.1144869867, -0.0607434074, -0.0037140713, -0.0418073559,  0.0019124492,  0.0138639627, -0.0052659958,  0.0867145187,  0.0338974646,  0.0038138676, -0.1015912773,  0.0106130081, -0.0157370877, -0.0073037351, -0.0209532426,  0.0024886294, -0.0211156356,  -0.014705923, -0.0304798026,  0.1160031044, -0.1012254278, -0.0027766374,  0.0235703441,  0.0065930439,  -0.009499924,  0.0250030522, -0.0078574508, -0.0082732708, -0.0125518119, -0.0094199183,  0.0074305459,  -0.100190146,  0.0373476138, -0.0599797145,  0.0844005275,  0.0003197245, -0.0001590676,  0.0133041662,  0.0159092627,  0.0092233792,  0.0162344395,  -0.003129501,  0.0214474185, -0.0193290672,  -2.79173e-05,  0.0269832582, -0.0304519609, -0.0751142692);
s(35,0) = (  0.0332764846, -0.0849192104, -0.0381146708, -0.0063509984,  0.0157369125,  0.0815530256, -0.0264817496,  0.0061961742, -0.1048513973,  0.1137008253, -0.0148529528,  0.0112949237,  0.0450814762,  0.0007273187,  0.0971851072,  0.0257762431, -0.0348838294, -0.1031606028,  0.0012697062, -0.0438866161,  0.0018758178, -0.0033480034, -0.0063737823, -0.0238721406,  0.1142017021, -0.1082578573,  0.0316502088,   0.017592697,  0.0040021539, -0.0076914011, -0.0209148343, -0.0004232808, -0.0259878066,  0.0045475837, -0.1012375878, -0.0419196553,  0.0461444618,  0.0931381864, -0.0079716317,  0.0111642461,  0.0020538828,  0.0262394089, -0.0078795177,  0.0020003109, -0.0156229473,  0.0026383072,   0.023404115,  0.0370264011, -0.0975774551,  0.0837992746, -0.0393039161,  -0.024775007,  -3.67876e-05,  0.0229882543, -0.0040552378,   0.009743697,  0.0162690639,  0.0005870362,  0.0264155447,  0.0048138673, -0.0001798413, -0.0106619559,  0.0806570414,  0.0472153461);
s(36,0) = (  0.0332780677, -0.0761373181, -0.0381082248, -0.0381584289,  0.0849498294,  0.0730908249, -0.0265027589,  0.0366740092, -0.0634670891,  0.0205387338, -0.0788197657,  0.0101825455,  0.0450816551,  0.0050588908,  0.0587534533,  0.1147795381, -0.1145178768, -0.0184506427,  0.0052216313, -0.0393618267,  0.0019288978, -0.0197666457, -0.0037685707, -0.1042714064, -0.0338739947,   0.079335645,  0.1016316346,  0.0029942836,  0.0211453094, -0.0069542992, -0.0209735411,  -0.003430363, -0.0157040199,  0.0178785105,  0.0303990396, -0.0847531372,  0.0373505701,  -0.068832253, -0.0235956158,  0.0019224479,  0.0125760034,  0.0235741455, -0.0078754586,  0.0118687661, -0.0095360089,  0.0113430224, -0.0073147191,  0.0728693158,  0.1012544748, -0.0955522864,  -0.030503718,   0.018763965,   0.000185637,  0.0043110222, -0.0215012443,  0.0087349816,  0.0162834242,  0.0042937493,  0.0159485864,  0.0231034003,   -6.8141e-05, -0.0193768411, -0.0843838884, -0.0107405322);
s(37,0) = (  0.0332831754, -0.0555537339, -0.0381257523,  -0.064552008,  0.1048604267,  0.0532821084, -0.0264656966,  0.0620499754,  0.0157690351, -0.0986704181, -0.0971801633,  0.0074615742,  0.0450405908,  0.0085114637, -0.0148640698,  0.0621376747,  0.0349633005,  0.0898373508,  0.0063732415, -0.0286306445,  0.0019300965, -0.0333782837,  0.0012383121,  -0.056046317,  -0.114204951,  0.0468373631, -0.0316830046, -0.0156342705,  0.0259465911, -0.0051694971, -0.0209439182, -0.0057918522,  0.0040276803,  0.0092629765,    0.10123154,  0.1062583351, -0.0975695189, -0.0396439448,  0.0079298113, -0.0097468642,   0.015671909,  0.0171366673, -0.0078643944,  0.0200021908,  0.0020745648,  0.0059574155, -0.0234356036, -0.0920617577, -0.0462522451,  0.0927134729,  0.0806471294,   0.010038106,   7.68928e-05, -0.0197007304, -0.0264154505,  0.0064764256,  0.0162231852,  0.0072882903, -0.0040980239,  0.0128795187,  0.0002672572,  0.0250706277,  0.0393384856, -0.0257833796);
s(38,0) = (   0.033262025,   -0.02683331,  -0.038106907, -0.0807815486,  0.0634244609,  0.0257299773, -0.0264737523,  0.0776301677,   0.084913401, -0.0956328312, -0.0587256485,  0.0036356788,  0.0451015225,  0.0107112616, -0.0788586638, -0.0666105993,  0.1144697399,  0.0867624818,  0.0037495468, -0.0138807103,  0.0018638532, -0.0418211413,  0.0053231116,  0.0607398002,  0.0338524301, -0.1159902829, -0.1016397165, -0.0147558584,  0.0157613236, -0.0024743522,  -0.020954784, -0.0072634247,  0.0211084481,  -0.010654657, -0.0304522329,  0.0038560119,  0.1012243324,  0.1002244189,  0.0236254311, -0.0094456322,  0.0094898742,  0.0082971303, -0.0078706125,  0.0250270509,  0.0125471882, -0.0065643064,  0.0074500028, -0.0028217151, -0.0373914746, -0.0751276451, -0.0844124578, -0.0270334006, -0.0001485078, -0.0193243821, -0.0159812814,  0.0031268797,  0.0163260623,  0.0092586087, -0.0214896009, -0.0133277433,   -7.3555e-05,  0.0003210999,  0.0304976886,  0.0600360228);
s(39,0) = (  0.0332889362,  0.0063723465, -0.0381110189, -0.0849515576, -0.0157880992, -0.0062148454,  -0.026511586,   0.081531368,  0.1048899032,  0.0258542794,  0.0148955627, -0.0007351595,  0.0450495131,  0.0113706473, -0.0971546459,   -0.11373347, -0.0349761593, -0.0239379552, -0.0012555685,  0.0033561705,   0.001976773, -0.0438664243,  0.0062842743,  0.1031277446,  0.1142157695,  0.0420065705,  0.0317340054,  0.0045288019, -0.0040178537,  0.0004477571, -0.0209579193, -0.0078250448,  0.0259923835, -0.0175188184, -0.1012038358, -0.1082450573, -0.0462033157, -0.0371185892, -0.0079546988,  0.0026653355, -0.0021099268, -0.0020259407, -0.0079194245,  0.0263113583,  0.0157073788,  -0.011168593,  0.0233680663,  0.0931028552,  0.0975375502,  0.0472258137,  0.0393917918,  0.0106568093,  -7.47334e-05,  0.0048921104,  0.0041236642, -0.0006097351,    0.01626429,  0.0097544845, -0.0264377739, -0.0230232326, -0.0001995695, -0.0247876416, -0.0806204048, -0.0837412433);
s(40,0) = (  0.0332756908,  0.0381559624, -0.0380960908, -0.0761377787,   -0.08494717, -0.0366713861, -0.0265181269,  0.0730725784,  0.0634754891,   0.114782502,  0.0788160802, -0.0050579153,   0.045085587,  0.0102043279, -0.0587313785, -0.0205581221, -0.1145367906, -0.1042617341, -0.0052292167,  0.0197700858,  0.0019149749, -0.0393557861,  0.0037344672,  0.0184255218,   -0.03384649,  0.0847945646,  0.1016184142,   0.017872489, -0.0211301287,  0.0034022102, -0.0209231856,  -0.006950037,  0.0156948461,  -0.002938836,  0.0304225828,  0.0793120637, -0.0374101892, -0.0728578718, -0.0235624777,  0.0113295685, -0.0125620132,  -0.011813337,   -0.00792248,  0.0234998506,  0.0095689812, -0.0019342688, -0.0073770564, -0.0688564052, -0.1012500651, -0.0106773966,  0.0304923773,  0.0193215738,   0.000173311,  0.0231050457,  0.0214400416, -0.0043456895,  0.0162700529,  0.0088412963, -0.0159358497, -0.0043505572,  -4.61094e-05,  0.0188154019,  0.0844157178,  0.0955760678);
s(41,0) = (  0.0332954171,  0.0645831634,  -0.038125736, -0.0555742417, -0.1049002459, -0.0620576654, -0.0265034338,  0.0532850213, -0.0157893063,  0.0621354631,  0.0971868825, -0.0085588732,  0.0450579213,  0.0074884495,  0.0148783533,  0.0987117205,  0.0349960134, -0.0560285587, -0.0063210535,   0.033408524,  0.0019653729, -0.0286318559, -0.0012163095, -0.0898580081, -0.1142063656, -0.1062499199, -0.0317195729,  0.0092491305, -0.0259753227,  0.0058275822, -0.0209633983, -0.0052142911, -0.0040637317,  0.0155879365,    0.10122519,  0.0467974309,  0.0974970884,  0.0920786264,  0.0079086046,  0.0059466018, -0.0157089289, -0.0200314625, -0.0078977388,  0.0171694592, -0.0020626395,  0.0097958751, -0.0234084812, -0.0396046227,  0.0462508151, -0.0257341366, -0.0806244514, -0.0250510344,  0.0001201536,  0.0128997755,  0.0264368766, -0.0073074087,  0.0162414918,  0.0064747947,  0.0040868485,  0.0197087467,  0.0002459659,  0.0100453244, -0.0393750136,  -0.092612809);
s(42,0) = (  0.0332589062,  0.0807724329,  -0.038106425, -0.0268395007, -0.0634306377, -0.0776333222, -0.0264746994,  0.0257443272, -0.0848944414, -0.0665812916,  0.0587464699, -0.0107077933,  0.0451193891,   0.003620543,  0.0788589033,   0.095629328,  0.1144481352,  0.0607352753, -0.0037694782,  0.0418489042,  0.0018425021, -0.0138627157, -0.0053293351, -0.0867820938,  0.0338199849, -0.0038780943, -0.1016547523, -0.0106664642, -0.0157324997,   0.007218139, -0.0209529073, -0.0025028215, -0.0211421058,  0.0147701077, -0.0304446329, -0.1159487026, -0.1011710184,  0.0028314223,  0.0236300814, -0.0066016802, -0.0095490048,  -0.024999366, -0.0078479016,    0.00831504, -0.0124733947,  0.0094240195,  0.0074730087,  0.1002364463,  0.0373885625,  0.0599995169,  0.0844252986,  -0.000285136, -0.0001461864, -0.0132190792,   0.016024986, -0.0092311843,  0.0162834514,  0.0031329543,  0.0214219074,  0.0193942095,   -4.5372e-05, -0.0270311865, -0.0305120557,  0.0750803513);
s(43,0) = (  0.0332866938,  0.0849326916, -0.0381360892,  0.0063599618,  0.0157526739, -0.0815692766, -0.0264612977, -0.0062161797, -0.1048605755, -0.1136994328, -0.0148935161, -0.0112916672,  0.0450462376, -0.0007140876,  0.0971953317, -0.0257925406, -0.0348904121,   0.103164592,  0.0012909985,  0.0438612704,  0.0019468816,  0.0033457879, -0.0063689418,  0.0239328306,  0.1141841246,  0.1082222259,  0.0317271065, -0.0175920539,  0.0040080587,  0.0077845981, -0.0209821788,   0.000445738, -0.0259740999, -0.0045755739, -0.1012325779,  0.0419041054,   0.046095044, -0.0931216335, -0.0080064515,  -0.011148865,  0.0020963748, -0.0263446442,  -0.007870136,  -0.002040661, -0.0157014246, -0.0026578418,  0.0234159816, -0.0371125069, -0.0975273868, -0.0837437887, -0.0393903982,  0.0248022175,  -7.29046e-05, -0.0230479225, -0.0041388024, -0.0097076365,  0.0162801612, -0.0005813793,  0.0265134752, -0.0048738085, -0.0002099724,  0.0107052259,  0.0806290553, -0.0471242207);
s(44,0) = (  0.0332847552,  0.0761565383, -0.0381014865,  0.0381720357,  0.0849756721, -0.0730759736,  -0.026528459, -0.0366880602, -0.0634856096, -0.0205540947,  -0.078833773, -0.0102195483,  0.0450876333, -0.0050463616,  0.0587200902, -0.1148136353, -0.1145611803,  0.0184048864,  0.0052370095,  0.0393619568,  0.0019212354,  0.0197491633,  -0.003712475,  0.1042655446, -0.0338621952, -0.0793319297,   0.101600287, -0.0029221923,  0.0211045672,  0.0069372634,  -0.020930383,  0.0034328654, -0.0157152063, -0.0178681539,  0.0304393239,  0.0848089291,  0.0374180849,  0.0688524929, -0.0235443215, -0.0019509702,  0.0125951567, -0.0234880035, -0.0078857562,  -0.011847148, -0.0095081314, -0.0113045677, -0.0073785087, -0.0728232345,  0.1012681845,  0.0955920547, -0.0304604661, -0.0187912022,  0.0002007052, -0.0042722149, -0.0214722095, -0.0087732135,  0.0162178579, -0.0043023665,  0.0158441527, -0.0231244658,  -3.77591e-05,  0.0192943256,  -0.084383438,  0.0106703489);


// ----- do not change anything below here ----

// mask for full ambisonic set to channels in use
input_mask(0) = bus(nc);
input_mask(1) = (_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_);


// Start of decoder implementation.  No user serviceable parts below here!
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------

//declare name		"Fill in name in configuration section below";
declare version 	"1.2";
declare author 		"AmbisonicDecoderToolkit";
declare license 	"BSD 3-Clause License";
declare copyright	"(c) Aaron J. Heller 2013";

/*
Copyright (c) 2013, Aaron J. Heller
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

1. Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.

3. Neither the name of the copyright holder nor the names of its
contributors may be used to endorse or promote products derived from
this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/

/*
  Author: Aaron J. Heller <heller@ai.sri.com>
  $Id: 21810b615fa65b96af41a7c8783d7435b41084b8 $
*/

// v 1.2, 28-Oct-2017 ajh
//  . add 6th-order NFC filters
//  . fixed error in speaker_chain and speaker_chain2, where speaker 
//    distance was being indexed by order, not speaker number

// v 1.1 remove dependancies on Faust Libraries, 23-Nov-2016 ajh
//   m = library("math.lib");
//   mu = library("music.lib");

m = environment {
  // from the old math.lib
  take (1, (xs, xxs)) = xs;
  take (1, xs) = xs;
  take (nn, (xs, xxs)) = take (nn-1, xxs);

  bus(2) = _,_; // avoids a lot of "bus(1)" labels in block diagrams
  bus(n) = par(i, n, _);

  SR = min(192000, max(1, fconstant(int fSamplingFreq, <math.h>)));
  //PI = 3.1415926535897932385;
  // quad precision value
  PI = 3.14159265358979323846264338327950288;
};

mu = environment {
   // from the old music.lib
   db2linear(x)	= pow(10, x/20.0);
};



// m.SR from math.lib is an integer, we need a float
SR = float(m.SR);

// descriptive statistics
total(c) = c:>_;

average(c) = total(c)/count(c);

count(c) = R(c) :>_ with {
 R((c,cl)) = R(c),(R(cl));
 R(c)      = 1;
};

rms(c) = R(c) :> /(count(c)) : sqrt with {
 R((c,cl)) = R(c),R(cl);
 R(c)      = (c*c);
};

sup(c) = R(c) with {
 R((c,cl)) = max(R(c),R(cl));
 R(c)      = c;
};

inf(c) = R(c) with {
 R((c,cl)) = min(R(c),R(cl));
 R(c)      = c;
};

// bus
bus(n)   = par(i,n,_);

// bus with gains
gain(c) = R(c) with {
  R((c,cl)) = R(c),R(cl);
  R(1)      = _;
  R(0)      = !:0;  // need to preserve number of outputs, faust will optimize away
  R(float(0)) = R(0);
  R(float(1)) = R(1);
  R(c)      = *(c);
};

// fir filter  (new improved, better behaved)
fir(c) = R(c) :>_ with {
  R((c,lc)) = _<: R(c), (mem:R(lc));
  R(c)      = gain(c);
};

// --- phase-matched bandsplitter from BLaH3
xover(freq,n) = par(i,n,xover1) with {

	sub(x,y) = y-x;

	k = tan(m.PI*float(freq)/m.SR);
	k2 = k^2;
	d =  (k2 + 2*k + 1);
	//d = (k2,2*k,1):>_;
	// hf numerator
	b_hf = (1/d,-2/d,1/d);
	// lf numerator
	b_lf = (k2/d, 2*k2/d, k2/d);
	// denominator
	a = (2 * (k2-1) / d, (k2 - 2*k + 1) / d);
	// 
	xover1 = _:sub ~ fir(a) <: fir(b_lf),fir(b_hf):_,*(-1);
};

shelf(freq,g_lf,g_hf) = xover(freq,1) : gain(g_lf),gain(g_hf):>_;

// from http://old.nabble.com/Re%3A--Faudiostream-devel---ANN--Faust-0.9.24-p28597267.html
//   (not used currently, do we need to worry about denormals?)
anti_denormal = pow(10,-20);
anti_denormal_ac = 1 - 1' : *(anti_denormal) : + ~ *(-1); 

// UI "dezipper"
smooth(c) = *(1-c) : +~*(c);
dezipper = smooth(0.999);

// physical constants     

temp_celcius = 20;                        
c = 331.3 * sqrt(1.0 + (temp_celcius/273.15)); // speed of sound m/s


// ---- NFC filters ----
//  see BesselPoly.m for coefficient calculations
//
// [1] J. Daniel, Spatial Sound Encoding Including Near Field Effect:
//     Introducing Distance Coding Filters and a Viable, New Ambisonic 
//     Format , Preprints 23rd AES International Conference, Copenhagen,
//     2003.
// [2] Weisstein, Eric W. "Bessel Polynomial." From MathWorld--A Wolfram 
//     Web Resource. http://mathworld.wolfram.com/BesselPolynomial.html
// [3] F. Adriaensen, Near Field filters for Higher Order
//     Ambisonics, Jul. 2006.
// [4] J. O. Smith, Digital State-Variable Filters, CCRMA, May 2013.
//
// [5] "A Filter Primer", https://www.maximintegrated.com/en/app-notes/index.mvp/id/733

// first and second order state variable filters see [4]
//   FIXME FIXME this code needs to be refactored, so that the roots are 
//               passed in rather then hardwired in the code, or another 
//               API layer, or ...
svf1(g,d1)    = _ : *(g) :       (+      <: +~_, _ ) ~ *(d1)                   : !,_ ;
svf2(g,d1,d2) = _ : *(g) : (((_,_,_):> _ <: +~_, _ ) ~ *(d1) : +~_, _) ~ *(d2) : !,_ ;

//  these are Bessel filters, see [1,2]
nfc1(r,gain) = svf1(g,d1)  // r in meters
 with {
   omega = c/(float(r)*SR);
   //  1  1
   b1 = omega/2.0;
   g1 = 1.0 + b1;
   d1 = 0.0 - (2.0 * b1) / g1;
   g = gain/g1;
};

nfc2(r,gain) = svf2(g,d1,d2)
 with {
   omega = c/(float(r)*SR);
   r1 = omega/2.0;
   r2 = r1 * r1;

   // 1.000000000000000   3.00000000000000   3.00000000000000
   b1 = 3.0 * r1;
   b2 = 3.0 * r2;
   g2 = 1.0 + b1 + b2;

   d1 = 0.0 - (2.0 * b1 + 4.0 * b2) / g2;  // fixed
   d2 = 0.0 - (4.0 * b2) / g2;
   g = gain/g2;
};

nfc3(r,gain) = svf2(g,d1,d2):svf1(1.0,d3)
 with {
   omega = c/(float(r)*SR);

   r1 = omega/2.0;
   r2 = r1 * r1;

   // 1.000000000000000   3.677814645373914   6.459432693483369
   b1 = 3.677814645373914 * r1;
   b2 = 6.459432693483369 * r2;         
   g2 = 1.0 + b1 + b2;
   d1 = 0.0 - (2.0 * b1 + 4.0 * b2) / g2;  // fixed
   d2 = 0.0 - (4.0 * b2) / g2;

   // 1.000000000000000   2.322185354626086
   b3 = 2.322185354626086 * r1;
   g3 = 1.0 + b3;
   d3 = 0.0 - (2.0 * b3) / g3;

   g = gain/(g3*g2);
};

nfc4(r,gain) = svf2(g,d1,d2):svf2(1.0,d3,d4)
 with {
   omega = c/(float(r)*SR);

   r1 = omega/2.0;
   r2 = r1 * r1;
   
   // 1.000000000000000   4.207578794359250  11.487800476871168
   b1 =  4.207578794359250 * r1;
   b2 = 11.487800476871168 * r2;         
   g2 = 1.0 + b1 + b2;
   d1 = 0.0 - (2.0 * b1 + 4.0 * b2) / g2;  // fixed
   d2 = 0.0 - (4.0 * b2) / g2;

   // 1.000000000000000   5.792421205640748   9.140130890277934
   b3 = 5.792421205640748 * r1;
   b4 = 9.140130890277934 * r2;         
   g3 = 1.0 + b3 + b4;
   d3 = 0.0 - (2.0 * b3 + 4.0 * b4) / g3;  // fixed
   d4 = 0.0 - (4.0 * b4) / g3;
   
   g = gain/(g3*g2);
};

nfc5(r,gain) = svf2(g,d1,d2):svf2(1.0,d3,d4):svf1(1.0,d5)
 with {
   omega = c/(float(r)*SR);

   r1 = omega/2.0;
   r2 = r1 * r1;
   
   // 1.000000000000000   4.649348606363304  18.156315313452325
   b1 =  4.649348606363304 * r1;
   b2 = 18.156315313452325 * r2;         
   g2 = 1.0 + b1 + b2;
   d1 = 0.0 - (2.0 * b1 + 4.0 * b2) / g2;  // fixed
   d2 = 0.0 - (4.0 * b2) / g2;

   // 1.000000000000000   6.703912798306966  14.272480513279568
   b3 =  6.703912798306966 * r1;
   b4 = 14.272480513279568 * r2;         
   g3 = 1.0 + b3 + b4;
   d3 = 0.0 - (2.0 * b3 + 4 * b4) / g3;  // fixed
   d4 = 0.0 - (4.0 * b4) / g3;

   // 1.000000000000000   3.646738595329718
   b5 = 3.646738595329718 * r1;
   g4 = 1.0 + b5;
   d5 = 0.0 - (2.0 * b5) / g4;

   g = gain/(g4*g3*g2);
 };

nfc6(r,gain) = svf2(g,d11,d12):svf2(1.0,d21,d22):svf2(1.0,d31,d32)
with {
   omega = c/(float(r)*SR);

   r1 = omega/2.0;
   r2 = r1 * r1;

   // reverse Bessel Poly 6:
   //   1          21         210        1260        4725       10395       10395
   // factors:
   //   1.000000000000000   5.031864495621642  26.514025344067996
   //   1.000000000000000   7.471416712651683  20.852823177396761
   //   1.000000000000000   8.496718791726696  18.801130589570320


   // 1.000000000000000   5.031864495621642  26.514025344067996
   b11 =  5.031864495621642 * r1;
   b12 = 26.514025344067996 * r2;         
   g1 = 1.0 + b11 + b12;
   d11 = 0.0 - (2.0 * b11 + 4.0 * b12) / g1;
   d12 = 0.0 - (4.0 * b12) / g1;

   // 1.000000000000000   7.471416712651683  20.852823177396761
   b21 =  7.471416712651683 * r1;
   b22 = 20.852823177396761 * r2;         
   g2 = 1.0 + b21 + b22;
   d21 = 0.0 - (2.0 * b21 + 4.0 * b22) / g2;
   d22 = 0.0 - (4.0 * b22) / g2;

   // 1.000000000000000   8.496718791726696  18.801130589570320
   b31 =  8.496718791726696 * r1;
   b32 = 18.801130589570320 * r2;         
   g3 = 1.0 + b31 + b32;
   d31 = 0.0 - (2.0 * b31 + 4.0 * b32) / g3;
   d32 = 0.0 - (4.0 * b32) / g3;

   g = gain/(g3*g2*g1);
};


// ---- End NFC filters ----

nfc(0,r,g) = gain(g);
nfc(1,r,g) = nfc1(r,g);
nfc(2,r,g) = nfc2(r,g);
nfc(3,r,g) = nfc3(r,g);
nfc(4,r,g) = nfc4(r,g);
nfc(5,r,g) = nfc5(r,g);
nfc(6,r,g) = nfc6(r,g);

// null NFC filters to allow very high order decoders. FIXME!
nfc(o,r,g) = gain(g);

//declare name "nfctest";
//process = bus(6):(nfc(0,2,1),nfc(1,2,1),nfc(2,2,1),nfc(3,2,1),nfc(4,2,1),nfc(5,2,1)):bus(6);


// top level api to NFC filters
nfc_out(1,order,r,g) = nfc(order,r,g);
nfc_out(0,order,r,g) = _;

nfc_inp(1,order,r,g) = nfc(order,r,g);
nfc_inp(0,order,r,g) = _;



// ---- delay and level
delay(dc,r)  = R(dc,r) with {
 R(0,r) = _;  // delay_comp off
 R(1,0) = _;  // delay_comp on, but no delay
 R(1,float(0)) = R(1,0);
 R(1,r) = @(meters2samples(r));
 meters2samples(r) = int(m.SR * (float(r)/float(c)) + 0.5);
};

level(lc,r,rmax) = R(lc,r,rmax) with{
 R(0,r,rmax) = _;  // level_comp off
 R(1,r,rmax) = gain(float(r)/float(rmax));
};


delay_level(r) = R(r) with {  // delay_comp and level_comp are free variables (fix?)
 R((r,rl)) =   R(r), R(rl);
 R(r)      =   delay(delay_comp,(r_max-r)) : level(level_comp,r,r_max);
};

// ---- gates
gate(0) = !;
gate(1) = _;
dirac(i,j) = i==j;
gate_bus(order,(o,oss)) = (gate(order==o),gate_bus(order,oss));
gate_bus(order,o)       =  gate(order==o);


// route (not used)
route(n_inputs,n_outputs,outs) = m.bus(n_inputs)
                               <: par(i,n_outputs,(0,gate_bus(i,outs)):>_)
                               : m.bus(n_outputs);

//process = route(4,4,(3,1,1,2)); // test


// deinterleave 
deinterleave(n,span) = par(i,n,_) <: par(i,span, par(j,n,gate(%(j,span)==i)));


// 1 band speaker chain
speaker_chain(ispkr) = gain(s(ispkr,0))  // decoder matrix gains
		     // iterate over orders, select each order from matrix
		     <: par(jord,no,gate_bus(jord,co)
		            // sum and apply NFC filter for that order
			    // at the speaker distance
		            :> nfc_out(nfc_output,jord,m.take(ispkr+1,rs),1.0))
		     // sum the orders
	             :>_;

// 1 band speaker chain -- bad definition
// speaker_chain(i) = gain(s(i,0)) <: par(i,no,gate_bus(i,co):>nfc_out(nfc_output,i,m.take(i+1,rs),1.0)):>_;

// near field correction at input, nfc_input = 1
nfc_input_bus(nc) = par(i,nc, nfc_inp(nfc_input, m.take(i+1,co), r_bar, 1.0));

// per order gains
gamma_bus(n) = par(i,nc, gain( m.take(m.take(i+1,co)+1, gamma(n))));

// output gain and muting
output_gain = hslider("gain [unit:dB]", -10, -30, +10, 1): mu.db2linear :*(checkbox("mute")<0.5): dezipper;

gain_muting_bus(0,n) = bus(n);
gain_muting_bus(1,n) = par(i,n,*(output_gain));


// one band decoder
decoder(1,nc,ns) = nfc_input_bus(nc) 
                :  gamma_bus(0) 
                <: par(is,ns, speaker_chain(is)) 
                : delay_level(rs); 


// two band decoder
//   there are two variants of the two-band decoder
//     1. classic, with shelf-filters and one matrix
//     2. vienna,  bandsplitting filters and separate LF and HF matricies.

// classic shelf filter decoder
decoder(2,nc,ns) = nfc_input_bus(nc) 
                :  par(i,nc, shelf(xover_freq,m.take(m.take(i+1,co)+1, gamma(0))/lfhf_ratio,
                                              m.take(m.take(i+1,co)+1, gamma(1))*lfhf_ratio))
                <: par(is,ns, speaker_chain(is)) 
                :  delay_level(rs);

// vienna decoder
//   FIXME FIXME  need to incorporate lfhf_ratio
decoder(3,nc,ns) = bus(nc)
                   : nfc_input_bus(nc) 
                   : xover(xover_freq,nc) : deinterleave(2*nc,2) 
                   : (gamma_bus(0),gamma_bus(1)) : bus(2*nc)
                   <: par(j, ns, speaker_chain2(j,nc))
                   : delay_level(rs)
; 
// 2 band speaker chain for vienna decoder
// i is speaker, j is order
speaker_chain2(i,nc) = gain(s(i,0)), gain(s(i,1))
                       :> bus(nc)
                       <: par(j,no,gate_bus(j,co):>nfc_out(nfc_output,j,m.take(i+1,rs),1.0))
                       :>_ ;

//process = speaker_chain2(1,16); // test



// --------------------------------------
//  things calculated from decoder config 

// maximum and average speaker distance
r_max = sup(rs);
r_bar = (rs :> float) / float(count(rs));

// number of ambisonic orders, including 0
no = decoder_order+1;

// number of input component signals
nc = count(co);



// the top-level process
process = input_mask(input_full_set):decoder(decoder_type,nc,ns):gain_muting_bus(output_gain_muting,ns);


// End of decoder implementation.  No user serviceable parts above here!
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------

//EOF!
